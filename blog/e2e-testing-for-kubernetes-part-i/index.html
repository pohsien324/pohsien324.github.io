<!DOCTYPE html>













<html lang="en"
  
>

  <!--
  The Head
-->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  
  <meta name="keywords" content="e2e, testing, kubernetes, kubetest, conformance, sonobuoy">
  
  <!-- Allow having a localized datetime different from the appearance language -->
  

  

    

    

  

  

  

  
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="End-to-End Testing for Kubernetes (Part I) - kubetest" />
<meta property="og:locale" content="en" />
<meta name="description" content="e2e, testing, kubernetes, kubetest, conformance, sonobuoy" />
<meta property="og:description" content="e2e, testing, kubernetes, kubetest, conformance, sonobuoy" />
<link rel="canonical" href="https://blog.phshih.com/blog/e2e-testing-for-kubernetes-part-i/" />
<meta property="og:url" content="https://blog.phshih.com/blog/e2e-testing-for-kubernetes-part-i/" />
<meta property="og:site_name" content="Po-Hsien Workspace" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-10-25T17:16:19+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="End-to-End Testing for Kubernetes (Part I) - kubetest" />
<meta name="twitter:site" content="@twitter_username" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2019-10-25T17:16:19+00:00","datePublished":"2019-10-25T17:16:19+00:00","description":"e2e, testing, kubernetes, kubetest, conformance, sonobuoy","headline":"End-to-End Testing for Kubernetes (Part I) - kubetest","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.phshih.com/blog/e2e-testing-for-kubernetes-part-i/"},"url":"https://blog.phshih.com/blog/e2e-testing-for-kubernetes-part-i/"}</script>
<!-- End Jekyll SEO tag -->

  

  <title>End-to-End Testing for Kubernetes (Part I) - kubetest | Po-Hsien Workspace
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Po-Hsien Workspace">
<meta name="application-name" content="Po-Hsien Workspace">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  

    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin>
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
    

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">

  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css">

  <link rel="stylesheet" href="/assets/css/style.css">

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css">
  

  <!-- JavaScript -->

  <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>

  
    <!--
  Switch the mode between dark and light.
-->

<script type="text/javascript">
  class ModeToggle {
    static get MODE_KEY() { return "mode"; }
    static get MODE_ATTR() { return "data-mode"; }
    static get DARK_MODE() { return "dark"; }
    static get LIGHT_MODE() { return "light"; }
    static get ID() { return "mode-toggle"; }

    constructor() {
      if (this.hasMode) {
        if (this.isDarkMode) {
          if (!this.isSysDarkPrefer) {
            this.setDark();
          }
        } else {
          if (this.isSysDarkPrefer) {
            this.setLight();
          }
        }
      }

      let self = this;

      /* always follow the system prefers */
      this.sysDarkPrefers.addEventListener("change", () => {
        if (self.hasMode) {
          if (self.isDarkMode) {
            if (!self.isSysDarkPrefer) {
              self.setDark();
            }

          } else {
            if (self.isSysDarkPrefer) {
              self.setLight();
            }
          }

          self.clearMode();
        }

        self.notify();

      });

    } /* constructor() */

    get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); }

    get isSysDarkPrefer() { return this.sysDarkPrefers.matches; }

    get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; }

    get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; }

    get hasMode() { return this.mode != null; }

    get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); }

    /* get the current mode on screen */
    get modeStatus() {
      if (this.isDarkMode
        || (!this.hasMode && this.isSysDarkPrefer)) {
        return ModeToggle.DARK_MODE;
      } else {
        return ModeToggle.LIGHT_MODE;
      }
    }

    setDark() {
      $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE);
    }

    setLight() {
      $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE);
    }

    clearMode() {
      $('html').removeAttr(ModeToggle.MODE_ATTR);
      sessionStorage.removeItem(ModeToggle.MODE_KEY);
    }

    /* Notify another plugins that the theme mode has changed */
    notify() {
      window.postMessage({
        direction: ModeToggle.ID,
        message: this.modeStatus
      }, "*");
    }

  } /* ModeToggle */

  const toggle = new ModeToggle();

  function flipMode() {
    if (toggle.hasMode) {
      if (toggle.isSysDarkPrefer) {
        if (toggle.isLightMode) {
          toggle.clearMode();
        } else {
          toggle.setLight();
        }

      } else {
        if (toggle.isDarkMode) {
          toggle.clearMode();
        } else {
          toggle.setDark();
        }
      }

    } else {
      if (toggle.isSysDarkPrefer) {
        toggle.setLight();
      } else {
        toggle.setDark();
      }
    }

    toggle.notify();

  } /* flipMode() */

</script>

  
</head>


  
    <!--
  Switch the mode between dark and light.
-->

<script type="text/javascript">
  class ModeToggle {
    static get MODE_KEY() { return "mode"; }
    static get MODE_ATTR() { return "data-mode"; }
    static get DARK_MODE() { return "dark"; }
    static get LIGHT_MODE() { return "light"; }
    static get ID() { return "mode-toggle"; }

    constructor() {
      if (this.hasMode) {
        if (this.isDarkMode) {
          if (!this.isSysDarkPrefer) {
            this.setDark();
          }
        } else {
          if (this.isSysDarkPrefer) {
            this.setLight();
          }
        }
      }

      let self = this;

      /* always follow the system prefers */
      this.sysDarkPrefers.addEventListener("change", () => {
        if (self.hasMode) {
          if (self.isDarkMode) {
            if (!self.isSysDarkPrefer) {
              self.setDark();
            }

          } else {
            if (self.isSysDarkPrefer) {
              self.setLight();
            }
          }

          self.clearMode();
        }

        self.notify();

      });

    } /* constructor() */

    get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); }

    get isSysDarkPrefer() { return this.sysDarkPrefers.matches; }

    get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; }

    get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; }

    get hasMode() { return this.mode != null; }

    get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); }

    /* get the current mode on screen */
    get modeStatus() {
      if (this.isDarkMode
        || (!this.hasMode && this.isSysDarkPrefer)) {
        return ModeToggle.DARK_MODE;
      } else {
        return ModeToggle.LIGHT_MODE;
      }
    }

    setDark() {
      $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE);
    }

    setLight() {
      $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE);
    }

    clearMode() {
      $('html').removeAttr(ModeToggle.MODE_ATTR);
      sessionStorage.removeItem(ModeToggle.MODE_KEY);
    }

    /* Notify another plugins that the theme mode has changed */
    notify() {
      window.postMessage({
        direction: ModeToggle.ID,
        message: this.modeStatus
      }, "*");
    }

  } /* ModeToggle */

  const toggle = new ModeToggle();

  function flipMode() {
    if (toggle.hasMode) {
      if (toggle.isSysDarkPrefer) {
        if (toggle.isLightMode) {
          toggle.clearMode();
        } else {
          toggle.setLight();
        }

      } else {
        if (toggle.isDarkMode) {
          toggle.clearMode();
        } else {
          toggle.setDark();
        }
      }

    } else {
      if (toggle.isSysDarkPrefer) {
        toggle.setLight();
      } else {
        toggle.setDark();
      }
    }

    toggle.notify();

  } /* flipMode() */

</script>

  

  <body data-spy="scroll" data-target="#toc" data-topbar-visible="true">

    <!--
  The Side Bar
-->

<div id="sidebar" class="d-flex flex-column align-items-end">
  <div class="profile-wrapper text-center">
    <div id="avatar">
      <a href="/" alt="avatar" class="mx-auto">
        
          
          <img src="
            
              /assets/images/pohsien.jpg
            
          " alt="avatar" onerror="this.style.display='none'">
        
      </a>
    </div>

    <div class="site-title mt-3">
      <a href="/">Po-Hsien Workspace</a>
    </div>
    <div class="site-subtitle font-italic">Cloud Native, Containerization, Virtualization, Linux Technologies.</div>

  </div><!-- .profile-wrapper -->

  <ul class="w-100">

    <!-- home -->
    <li class="nav-item">
      <a href="/" class="nav-link">
        <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i>
        <span>HOME</span>
      </a>
    </li>
    <!-- the real tabs -->
    
    <li class="nav-item">
      <a href="/categories/" class="nav-link">
        <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>CATEGORIES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/tags/" class="nav-link">
        <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>TAGS</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/archives/" class="nav-link">
        <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>ARCHIVES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/about/" class="nav-link">
        <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>ABOUT</span>
      </a>
    </li> <!-- .nav-item -->
    

  </ul> <!-- ul.nav.flex-column -->

  <div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center">

    
      <button class="mode-toggle btn" aria-label="Switch Mode">
        <i class="fas fa-adjust"></i>
      </button>

      
        <span class="icon-border"></span>
      
    

    
      

      
      <a href="https://github.com/pohsien324" aria-label="github"
        target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
      

    
      

      
      <a href="
          javascript:location.href = 'mailto:' + ['pohsien324','gmail.com'].join('@')" aria-label="email"
        >
        <i class="fas fa-envelope"></i>
      </a>
      

    
      

      
      <a href="https://www.linkedin.com/in/po-hsien-shih-23bbb1162/" aria-label="linkedin"
        target="_blank" rel="noopener">
        <i class="fab fa-linkedin"></i>
      </a>
      

    
      

      
      <a href="/feed.xml" aria-label="rss"
        >
        <i class="fas fa-rss"></i>
      </a>
      

    

  </div> <!-- .sidebar-bottom -->

</div><!-- #sidebar -->


    <!--
  The Top Bar
-->

<div id="topbar-wrapper" class="row justify-content-center">
  <div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between">
    <span id="breadcrumb">

    

    

      

        
          <span>
            <a href="/">
              Home
            </a>
          </span>

        

      

        

      

        

          
            <span>End-to-End Testing for Kubernetes (Part I) - kubetest</span>
          

        

      

    

    </span><!-- endof #breadcrumb -->

    <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i>

    <div id="topbar-title">
      Post
    </div>

    <i id="search-trigger" class="fas fa-search fa-fw"></i>
    <span id="search-wrapper" class="align-items-center">
      <i class="fas fa-search fa-fw"></i>
      <input class="form-control" id="search-input" type="search"
        aria-label="search" autocomplete="off" placeholder="Search...">
    </span>
    <span id="search-cancel" >Cancel</span>
  </div>

</div>


    <div id="main-wrapper">
      <div id="main">

        









<div class="row">

  <!-- core -->
  <div id="core-wrapper" class="col-12 col-lg-11 col-xl-8">
    <div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">

    

    
      
      
        <!--
  Refactor the HTML structure.
-->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Add attribute 'hide-bullet' to the checkbox list -->



<!-- images -->




  
  

  
    
      
      
    

    
    
    

    
    

    
    
    

    
      
      

      
      

      

      
    
      
      

      
      

      

      
    

    
      

        <!-- Add CDN URL -->
        

        <!-- Add image path -->
        

        
        

      

      <!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> -->

      

    

    <!-- Add SVG placehoder to prevent layout reflow -->

    

    <!-- Bypass the HTML-proofer test -->
    

    

  
    

    
    
    

    
    

    
    
    

    
      
      

      
      

      

      
    
      
      

      
      

      

      
    

    
      

        <!-- Add CDN URL -->
        

        <!-- Add image path -->
        

        
        

      

      <!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> -->

      

    

    <!-- Add SVG placehoder to prevent layout reflow -->

    

    <!-- Bypass the HTML-proofer test -->
    

    

  
    

    
    
    

    
    

    
    
    

    
      
      

      
      

      

      
    
      
      

      
      

      

      
    

    
      

        <!-- Add CDN URL -->
        

        <!-- Add image path -->
        

        
        

      

      <!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> -->

      

    

    <!-- Add SVG placehoder to prevent layout reflow -->

    

    <!-- Bypass the HTML-proofer test -->
    

    

  
    

    
    
    

    
    

    
    
    

    
      
      

      
      

      

      
    
      
      

      
      

      

      
    

    
      

        <!-- Add CDN URL -->
        

        <!-- Add image path -->
        

        
        

      

      <!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> -->

      

    

    <!-- Add SVG placehoder to prevent layout reflow -->

    

    <!-- Bypass the HTML-proofer test -->
    

    

  
    

    
    
    

    
    

    
    
    

    
      
      

      
      

      

      
    
      
      

      
      

      

      
    

    
      

        <!-- Add CDN URL -->
        

        <!-- Add image path -->
        

        
        

      

      <!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> -->

      

    

    <!-- Add SVG placehoder to prevent layout reflow -->

    

    <!-- Bypass the HTML-proofer test -->
    

    

  
    

    
    
    

    
    

    
    
    

    
      
      

      
      

      

      
    
      
      

      
      

      

      
    

    
      

        <!-- Add CDN URL -->
        

        <!-- Add image path -->
        

        
        

      

      <!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> -->

      

    

    <!-- Add SVG placehoder to prevent layout reflow -->

    

    <!-- Bypass the HTML-proofer test -->
    

    

  
    

    
    
    

    
    

    
    
    

    
      
      

      
      

      

      
    
      
      

      
      

      

      
    

    
      

        <!-- Add CDN URL -->
        

        <!-- Add image path -->
        

        
        

      

      <!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> -->

      

    

    <!-- Add SVG placehoder to prevent layout reflow -->

    

    <!-- Bypass the HTML-proofer test -->
    

    

  

  



<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    

    

  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    

    

  

  
  

  

  
  

  




<!-- Wrap prompt element of blockquote with the <div> tag -->







  
  

  

    
      
      

    

    
    

    
    
    

    
      
        
        

    

    
    

    

  

    

    
    

    
    
    

    
      
        
        

    

    
    

    

  

    

    
    

    
    
    

    
      
        
        

    

    
    

    

  

    

    
    

    
    
    

    
      
        
        

    

    
    

    

  

    

    
    

    
    
    

    
      
        
        

    

    
    

    

  

    

    
    

    
    
    

    
      
        
        

    

    
    

    

  

    

    
    

    
    
    

    
      
        
        

    

    
    

    

  

    

    
    

    
    
    

    
      
        
        

    

    
    

    

  

    

    
    

    
    
    

    
      
        
        

    

    
    

    

  

    

    
    

    
    
    

    
      
        
        

    

    
    

    

  

  



<!-- return -->







<h1 data-toc-skip>End-to-End Testing for Kubernetes (Part I) - kubetest</h1>

<div class="post-meta text-muted">

  <!-- author -->
  <div>
    
    

    

    By
    <em>
      
        <a href="https://github.com/username">Po-Hsien Shih</a>
      
    </em>
  </div>

  <div class="d-flex">
    <div>
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/timeago.js
-->

<em class="timeago"
    data-ts="1572023779"
    
      data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll"
    
    >
  2019-10-25
</em>

      </span>

      <!-- lastmod date -->
      

      <!-- read time -->
      <!--
  Calculate the post's reading time, and display the word count in tooltip
 -->



<!-- words per minute  -->










<!-- return element -->
<span class="readtime" data-toggle="tooltip" data-placement="bottom"
  title="7689 words">
  <em>42 min</em> read</span>


      <!-- page views -->
      
    </div>

  </div> <!-- .d-flex -->

</div> <!-- .post-meta -->

<div class="post-content">
  <p>現今 Kubernetes Cluster 部署方式越來越多種，部署門檻也越來越低，但是在部署完之後要如何確認自己的 Cluster 真的是正常可用的？ 大多數的人(包含筆者以前)都是簡單部署一些 <code class="language-plaintext highlighter-rouge">Deployment</code> 或是 <code class="language-plaintext highlighter-rouge">Service</code> 看是否有 running 就認為 Cluster 是正常的，或是部署時沒有看到什麼錯誤訊息就覺得沒事，但是這樣是不太足夠的，因為有可能壞掉的是一些不常使用的功能或是人工比較難已發現的問題，這樣之後如果使用者部署應用時剛好使用到相關功能，發生問題將會很難查找。</p>

<p>為了確認 Cluster 功能是否正常，我們可以針對 Cluster 做完整的測試，測試各個API是否正常，但是筆者查了一下發現網路上比較少關於 Kubernetes 測試的詳細資訊，因此花了一點時間研究並紀錄在此系列文章。</p>

<blockquote class="prompt-tip"><div>
  <p>注意， Kubernetes 的測試有非常多種層面，例如： Unit Testing 、 Integration Testing 、 E2E Testing 、 Performance/Benchmark Testing 、 Load Testing 、 Stress Testing 或是 Security Testing，但是在此系列文中，強調的是<code class="language-plaintext highlighter-rouge">測試 Cluster 的功能是否正常</code>，因此重點會放在 E2E Testing 上。</p>
</div></blockquote>

<p>E2E Testing for Kubernetes:</p>
<ul>
  <li><a href="/blog/e2e-testing-for-kubernetes-part-i/">End-to-End Testing for Kubernetes (Part I) - kubetest</a></li>
  <li><a href="/blog/e2e-testing-for-kubernetes-part-ii/">End-to-End Testing for Kubernetes (Part II) - Conformance Testing</a></li>
</ul>

<!--more-->

<p>另外筆者在 Cloud Native Taiwan User Group (CNTUG) Meetup #20 也有一場 talk 是在介紹這個主題，大家可以參考以下的簡報：</p>
<div style="left: 10%; width: 100%; height: 0; position: relative; padding-bottom: 56.1972%;"><iframe src="//speakerdeck.com/player/8de155b223c54271b88421f2b5a0608d" style="border: 0; top: 0; left: 0; width: 80%; height: 80%; position: absolute;" allowfullscreen="" scrolling="no" allow="encrypted-media"></iframe></div>

<h1 id="software-testing">Software Testing</h1>
<p>一般 Software Testing 可分成三種比較常見的測試方式:</p>

<p><strong>Unit Testing</strong><br />
單元測試，測試單一功能或是某個函數，例如測試登入功能是否正常。這種測試維度比較小，測試程式的撰寫也比較單純一點。</p>

<p><strong>Integration Testing</strong><br />
整合測試，這種通常是測試多個具有關聯或相依性的功能(或函數)整合之後是否正常，維度比單元測試還要大一點。</p>

<p><strong>End to End (E2E) Testing</strong><br />
前面單元測試跟整合測試兩個都是比較偏向 Developer 驗證 Code 或是函數是否正常，而 E2E 測試比較偏向以使用者角度去操作系統，測試人員把自己當成一般使用者去對整個系統做操作，測試每個功能是否正常。</p>

<p>由於我們只是要確認 Kubernetes Cluster 功能是否正常，並不是要開發，因此此系列文會著重在 Kubernetes E2E Testing。</p>

<h1 id="sig-testing">SIG-Testing</h1>
<p><code class="language-plaintext highlighter-rouge">Special Interest Group (SIG)</code> 是由一群志同道合來自各公司各領域的人組成的組織或是團體，主要是一起學習某個技術、對某個技術進行探討或是一起維護某個專案，類似社群的概念，這些 SIG 可能也會定期的舉辦 Meetup 或是 Conference 等。 Kubernetes Community 是由許多不同的 SIG 組成，例如: <code class="language-plaintext highlighter-rouge">sig-network</code> 是負責 Kubernetes 中網路部分、 <code class="language-plaintext highlighter-rouge">sig-docs</code> 是負責文件、而 <code class="language-plaintext highlighter-rouge">sig-storage</code> 是負責儲存部分等等。每個 SIG 都有自己負責的 Subproject ，這些 Subproject 可能是文件撰寫，也有可能是 Code 撰寫。除了 SIG 之外，Kubnernetes Community還有其他的 Subgroups 如 Committees 、Working Groups 跟 User Groups 等等，</p>

<p>如果對於 Kubernetes Community 組成有興趣，可以參考: <a href="https://github.com/kubernetes/community/blob/master/governance.md">Kubernetes Community Governance Model</a> 。
如果想了解 Kubernetes 中各個 SIG，可以參考: <a href="https://github.com/kubernetes/community/blob/master/sig-list.md">Kubernetes SIGs and Working Groups</a>。
如果想了解各個 SIG 負責的 Subproject ，可以參考: <a href="https://github.com/kubernetes/community/blob/master/sigs.yaml">Subprojects of each SIGs</a>。</p>

<p>在眾多 SIG 當中，負責 Kubernetes 測試的是 <a href="https://github.com/kubernetes/community/tree/master/sig-testing#testing-special-interest-group">sig-testing</a> ， sig-testing 負責許多知名的 subprojects ，如管理      Kubernetes project 的 CI/CD 系統 - <a href="https://github.com/kubernetes/test-infra/tree/master/prow">prow</a> ，以及部署 K8s in docker 的 <a href="https://github.com/kubernetes-sigs/kind">kind</a> 等等。在這裡我們主要會提到的是 - <a href="https://github.com/kubernetes/test-infra">test-infra</a> 。 test-infra 提供了許多供 Kubernetes 測試的工具，裡面包含了我們要介紹的 Kubernetes E2E Testing Tool - <a href="https://github.com/kubernetes/test-infra/tree/master/kubetest">kubetest</a>。</p>

<p><img data-src="/assets/images/e2e_k8s/kubetest.png" style="width:100%" data-proofer-ignore></p>

<h1 id="cluster-e2e-testing">Cluster E2E Testing</h1>
<p>Kubernetes E2E Testing 主要是驗證所有的功能 (包含 API Server 以及 Controller ) 是否是正常可用的，且 API 行為必須跟 Spec 上一樣。透過這種測試能夠找出一些 Unit Test 、 Integration Test 或是人工難以找出的問題。</p>

<h2 id="kubetest-usage"><span class="mr-2">Kubetest Usage</span><a href="#kubetest-usage" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2>
<p>test-infra 釋出了可以對 Kubernetes Cluster 做 E2E Test 的工具 - <code class="language-plaintext highlighter-rouge">kubetest</code> ，不過 kubetest 其實是一個整合的介面，他不只可以做一般的 E2E Test ，還整合了如 Conformance Test, Node E2E Test 以及 Performance Test 等等的測試，後續我們會再細部介紹 kubetest 的運作流程。</p>

<p>這邊需要注意的是: kubetest 在執行 E2E Test 時，會開啟一個乾淨的 Cluster 來做測試，這樣的用意是因為  Kubernetes 是想要針對整個 Kubernetes Source Code 做 E2E Test ，這樣才可以確保當前 Release 出來的 Kubernetes 版本是正常可用的。 因此 kubetest 在執行時會去尋找 Kubernetes Repository ，找到後再 Build Source Code ，接著開啟新的 Cluster 測試。</p>

<blockquote class="prompt-info"><div>
  <p>kubetest 其實也有被整合到 <a href="https://github.com/kubernetes/test-infra/tree/master/prow">prow</a> 裡面，任何 Pull Requet 在被 Merge 前，也都會透過 kubetest 進行測試。</p>
</div></blockquote>

<p>Execution:</p>
<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>kubetest <span class="nt">--build</span> <span class="nt">--provider</span> &lt;yourprovider&gt; <span class="nt">--deployment</span> &lt;yourdeployer&gt; <span class="nt">--up</span> <span class="nt">--test</span> <span class="nt">--test_args</span><span class="o">=</span><span class="s2">"--ginkgo.skip(focus)=xxx"</span> <span class="nt">--dump</span> &lt;folder&gt; <span class="nt">--down</span>
</pre></td></tr></tbody></table></code></div></div>
<blockquote>
  <p>Flag:<br />
<code class="language-plaintext highlighter-rouge">--build</code>:       Build binaries (e2e.test, e2e_node.test) for testing.<br />
<code class="language-plaintext highlighter-rouge">--provider</code>:    Specify an alternative provider (gce, local, gke, aks, etc.) for E2E testing, default value is gce. <br />
<code class="language-plaintext highlighter-rouge">--deployment</code>:  Deployment strategies of Kubernetes cluster.  (gce, local, gke, aks, etc.)<br />
<code class="language-plaintext highlighter-rouge">--up</code>:          Turn up a new cluster.     <br />
<code class="language-plaintext highlighter-rouge">--test</code>:        Run E2E testing.<br />
<code class="language-plaintext highlighter-rouge">--test_args</code>:   Test matching for ginkgo.<br />
<code class="language-plaintext highlighter-rouge">--down</code>:        Shutdown and delete the cluster.<br />
<code class="language-plaintext highlighter-rouge">--dump</code>:        Export the result. ( junit xml format )</p>
</blockquote>

<p>這邊比較容易搞混的是 <code class="language-plaintext highlighter-rouge">--provider</code> 以及 <code class="language-plaintext highlighter-rouge">--deployment</code> ，官方文件對這兩個 flag 並沒有太多的解釋，經過筆者研究了之後，整理出來結論是: <code class="language-plaintext highlighter-rouge">--provider</code> 比較像是告訴 kubetest 要在哪個平台上做測試或著是告訴 kubetest 準備哪一個平台使用的 Test Lists，而 <code class="language-plaintext highlighter-rouge">--deployment</code> 比較像是告訴 kubetest 你的 Cluster 位置，讓 kubetest 可以存取到 Cluster 。舉例來說如果你設定 <code class="language-plaintext highlighter-rouge">--deployment gke</code> ， kubetest 就會知道你的 Cluster 是用 gke 佈出來的，接下來就會等你再提供一些 gke 相關參數(例如提供 <code class="language-plaintext highlighter-rouge">kubeconfig</code> 或是一些 token 之類的)，讓 kubetest 能夠存取得到你的 Cluster 。需要注意的是 <code class="language-plaintext highlighter-rouge">--provider</code> 跟 <code class="language-plaintext highlighter-rouge">--deployment</code> 兩個平台必須一致，否則 kubetest 會無法測試並且報錯，例如 <code class="language-plaintext highlighter-rouge">--provider local</code> 配上 <code class="language-plaintext highlighter-rouge">--deployment gke</code> 或是 <code class="language-plaintext highlighter-rouge">--provider gke</code> 配 <code class="language-plaintext highlighter-rouge">--deployment local</code> 這種情況是不行的。</p>

<blockquote class="prompt-tip"><div>
  <p>筆者實際執行完整的 E2E Test 大概花了一天左右，不過可能跟筆者 Homelab 硬體資源有關，實際上應該不需要這多時間。</p>
</div></blockquote>

<p><img data-src="/assets/images/e2e_k8s/e2e-running.png" style="width:100%" data-proofer-ignore></p>

<p>使用 <code class="language-plaintext highlighter-rouge">--dump</code> flag 會將測試結果存成 JUnit 格式，裡面會寫所有執行的測項以及測試結果 (包括失敗訊息):
<img data-src="/assets/images/e2e_k8s/junit-output.png" style="width:100%" data-proofer-ignore></p>

<h2 id="kubetest-workflow"><span class="mr-2">Kubetest Workflow</span><a href="#kubetest-workflow" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2>
<p>接下來解釋一下 kubetest 運作流程，到底執行 kubetest 之後它做哪些事情呢？</p>

<p><img data-src="/assets/images/e2e_k8s/kubetest-workflow.png" style="width:100%" data-proofer-ignore></p>

<p>上圖為 kubetest 簡單的執行流程圖，基本上大致流程是 <code class="language-plaintext highlighter-rouge">kubernetes/hack/e2e.go -&gt; test-infra/kubetest -&gt; kubernetes/hack/ginkgo-e2e.sh -&gt; kubernetes/test/e2e/e2e_test.go -&gt; kubernetes/test/e2e/framework/framework.go -&gt; Start E2E testing</code> 。</p>

<h3 id="stage-1-kuberneteshacke2ego---test-infrakubetest"><span class="mr-2">Stage 1: <code class="language-plaintext highlighter-rouge"><span class="mr-2">kubernetes/hack/e2e.go -&gt; test-infra/kubetest</code></span><a href="#stage-1-kuberneteshacke2ego---test-infrakubetest" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3>
<p><strong><code class="language-plaintext highlighter-rouge">kubernetes/hack/e2e.go</code></strong>
在以往還沒有 kubetest 的時候， Kubernetes 測試都是各自分開的介面，而其中 E2E Testing 部分就是 <code class="language-plaintext highlighter-rouge">kubernetes/hack/e2e.go</code> 負責，但是 sig-testing 可能是為了整合這些介面，因此開發了 kubetest ，來讓測試人員能夠直接使用單一介面來做到各式各樣的測試( Cluster E2E Test 、 Node E2E Test 或 Performance Test 等等)。如果你直接去看 <code class="language-plaintext highlighter-rouge">kubernetes/hack/e2e.go</code> 的 Source Code，你會發現其實它也是會去抓 kubetest 並且執行 kubetest ，所以你可能會看到網路上一些文章介紹 E2E Testing 的時候是執行 <code class="language-plaintext highlighter-rouge">hack/e2e.go --provider xxx ...</code> 而不是 <code class="language-plaintext highlighter-rouge">kubetest --provider ...</code> ，這兩個其實是一樣的。</p>

<p><img data-src="/assets/images/e2e_k8s/hack-e2e-lookkubetest.png" style="width:100%" data-proofer-ignore>
<img data-src="/assets/images/e2e_k8s/hack-e2e-getkubetest.png" style="width:100%" data-proofer-ignore></p>

<p>如果你去看 <code class="language-plaintext highlighter-rouge">kubernetes/hack/e2e.go</code> 的 history ，可以看到他在2017年的時候把 Code 整個改成 kubetest 介面，由此可以得知是從那個時候開始整合進去的。</p>

<p><img data-src="/assets/images/e2e_k8s/hack-e2e-history.png" style="width:100%" data-proofer-ignore></p>

<h3 id="stage-2-test-infrakubetest---kuberneteshackginkgo-e2esh"><span class="mr-2">Stage 2: <code class="language-plaintext highlighter-rouge"><span class="mr-2">test-infra/kubetest -&gt; kubernetes/hack/ginkgo-e2e.sh</code></span><a href="#stage-2-test-infrakubetest---kuberneteshackginkgo-e2esh" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3>
<p><strong>Ginkgo &amp; Gomega</strong><br />
Kubernetes E2E Testing 所有測項其實都是用 <a href="https://onsi.github.io/ginkgo/">Ginkgo</a> 以及 <a href="http://onsi.github.io/gomega/">Gomega</a> 撰寫的， Ginkgo 是 Golang 的 <code class="language-plaintext highlighter-rouge">Behavior-Driven Development (BDD) Testing Framework</code> ，而 Gomaga 是 Golang 的 Matcher Library， 用在測項結果比對。</p>

<p>這邊簡單解釋一下 BDD 為何，一般在做 Software Testing 時， RD 或是 QA 可能會依照規格書撰寫出對應的測試 Code ，但是這些 Code 可能只有技術人員看得懂，這樣會導致技術與非技術人員很難協同作業或討論，因此很容易發生開發者誤解測項或是規格書制定不清楚的情況。而 BDD 就是為了解決這個問題，讓開發人員以及非技術人員能夠一同協作的一種開發方式，首先大家會共同制定一份規格書，規格書會使用更接近人類語意的自然語言來描述軟體功能和測試案例，制定完後， QA 能夠直接執行這份規格書來測試，無需再額外寫一些複雜的測試 Code，簡單來說 BDD 就是以軟體的行為來描述測試，讓大家都能看懂。</p>

<p>Ginkgo 主要由以下三個部分組成：</p>
<ol>
  <li>Main Program: 主要要測的程式。</li>
  <li>Test Suite: 測試包，通常會包含很多 Spec (測項)。</li>
  <li>Spec: 測項 (可能一個或多個)。</li>
</ol>

<p>以下使用簡單的範例來介紹如何使用 Ginkgo 和 Gomaga ，<a href="https://github.com/pohsienshih/ginkgo-gomega-example">範例 Code</a> 可以從筆者 GitHub 上下載，有興趣可以去載下來執行看看。</p>

<ol>
  <li>下載並安裝 Ginkgo 和 Gomega
    <div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>go get github.com/onsi/ginkgo/ginkgo
<span class="nv">$ </span>go get github.com/onsi/gomega/...
<span class="c"># Install Ginkgo CLI</span>
<span class="nv">$ </span>go <span class="nb">install </span>github.com/onsi/ginkgo/ginkgo
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>
    <p>這邊撰寫一個簡單的 <code class="language-plaintext highlighter-rouge">myproject package</code> ，裡面會有兩個函數: <code class="language-plaintext highlighter-rouge">Greeting()</code> 和 <code class="language-plaintext highlighter-rouge">Calc()</code> 。 <code class="language-plaintext highlighter-rouge">Greeting()</code> 功能是是傳入一個字串，會回傳 <code class="language-plaintext highlighter-rouge">Hello xxx</code> 的打招呼函數； <code class="language-plaintext highlighter-rouge">Calc()</code> 是傳入一個數值，會回傳十倍的值給你。</p>

    <p><code class="language-plaintext highlighter-rouge">myproject.go</code></p>

    <div class="language-go highlighter-rouge"><div class="code-header">
        <span data-label-text="Go"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="k">package</span> <span class="n">myproject</span>

<span class="k">func</span> <span class="n">Greeting</span><span class="p">(</span><span class="n">name</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">string</span><span class="p">{</span> 
   <span class="k">return</span> <span class="s">"Hello "</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s">"."</span>
<span class="p">}</span>
<span class="k">func</span> <span class="n">Calc</span><span class="p">(</span><span class="n">number</span> <span class="kt">int</span><span class="p">)</span> <span class="kt">int</span><span class="p">{</span> 
   <span class="k">return</span> <span class="n">number</span> <span class="o">*</span> <span class="m">10</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>新增 Test Suite ， Test Suite 就是測試包的意思，測試包會去抓所有的測試檔，並執行裡面的測項 ( Spec )。
    <div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">cd </span>myproject
<span class="nv">$ </span><span class="nb">ls
</span>myproject.go
<span class="nv">$ </span>ginkgo bootstrap
<span class="nv">$ </span><span class="nb">ls
</span>myproject.go myproject_suite_test.go
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>
    <p>查看 Test Suite ，會發現裡面會有一個 <code class="language-plaintext highlighter-rouge">Testxxx()</code> 函數。預設 Golang 本身就有支援測試的功能 ( <code class="language-plaintext highlighter-rouge">go test</code> )，當執行 <code class="language-plaintext highlighter-rouge">go test</code> 後， go 會去抓目錄底下所有 <code class="language-plaintext highlighter-rouge">xxx_test.go</code> 的檔案，並執行這些 go 檔裡面 <code class="language-plaintext highlighter-rouge">Testxxx()</code> 的函數，這些函數就是你寫的測項。 Ginkgo 也是使用 <code class="language-plaintext highlighter-rouge">go test</code> 這種特性，讓 go 先去執行 <code class="language-plaintext highlighter-rouge">Testxxx()</code>，只不過在這個<code class="language-plaintext highlighter-rouge"> Testxxx()</code> 函數裡執行的是 Ginkgo 的函數 <code class="language-plaintext highlighter-rouge">RunSpecs()</code> ， <code class="language-plaintext highlighter-rouge">RunSpecs()</code> 會去抓目錄底下所有的測項 ( Spec ) 。</p>

    <p><code class="language-plaintext highlighter-rouge">myproject_suite_test.go</code></p>

    <div class="language-go highlighter-rouge"><div class="code-header">
        <span data-label-text="Go"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="k">package</span> <span class="n">myproject_test</span> 

<span class="k">import</span> <span class="p">(</span>
      <span class="s">"testing"</span>
      <span class="o">.</span> <span class="s">"github.com/onsi/ginkgo"</span>
      <span class="o">.</span> <span class="s">"github.com/onsi/gomega"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">TestMyproject</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">RegisterFailHandler</span><span class="p">(</span><span class="n">Fail</span><span class="p">)</span>
      <span class="n">RunSpecs</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s">"Myproject Suite"</span><span class="p">)</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>接著就是產生測試檔
    <div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>ginkgo generate mytest
<span class="nv">$ </span><span class="nb">ls
</span>myproject.go myproject_suite_test.go mytest_test.go
</pre></td></tr></tbody></table></code></div>    </div>

    <p><code class="language-plaintext highlighter-rouge">mytest_test.go</code></p>
    <div class="language-go highlighter-rouge"><div class="code-header">
        <span data-label-text="Go"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre> <span class="k">package</span> <span class="n">myproject_test</span> 
 <span class="k">import</span> <span class="p">(</span>
         <span class="o">.</span> <span class="s">"github.com/onsi/ginkgo"</span>
         <span class="o">.</span> <span class="s">"github.com/onsi/gomega"</span>
         <span class="o">.</span> <span class="s">"github.com/myproject"</span>
 <span class="p">)</span>
 <span class="k">var</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Describe</span><span class="p">(</span><span class="s">"Mytest"</span><span class="p">,</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
 <span class="p">})</span>
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>
    <p>撰寫測項 ( Spec ) ，如果你曾經有寫過其他語言的測試，你可能會發現 Ginkgo 架構與他們非常相似，都是由三個部分組成: <code class="language-plaintext highlighter-rouge">Describe</code> , <code class="language-plaintext highlighter-rouge">Context</code> 以及 <code class="language-plaintext highlighter-rouge">It</code> ， Describe 是描述這個 Spec ，例如: <code class="language-plaintext highlighter-rouge">測試 Greeting() 函數</code> 。 Context 是補充說明這個 Spec ，可以增加條件式或是任何規則還讓 Spec 行為更加明確，例如： <code class="language-plaintext highlighter-rouge">傳給它一個字串</code> 或是 <code class="language-plaintext highlighter-rouge">傳給它一個中英文夾雜的字串</code> 等等。最後 It 是預期達到的結果，例如： <code class="language-plaintext highlighter-rouge">應該要跟我打招呼</code> , <code class="language-plaintext highlighter-rouge">要回傳什麼值</code> 或 <code class="language-plaintext highlighter-rouge">要報錯</code> 等等。</p>

    <p>在此範例中， Spec 1 是測試傳入一個字串給 <code class="language-plaintext highlighter-rouge">Greeing()</code> ，驗證是否會回傳 <code class="language-plaintext highlighter-rouge">Hello &lt;字串&gt;</code>。 Spec 2 是測試傳入一個數值給 <code class="language-plaintext highlighter-rouge">Calc()</code> ，驗證是否會回傳十倍的值。</p>

    <p><code class="language-plaintext highlighter-rouge">mytest_test.go</code></p>
    <div class="language-go highlighter-rouge"><div class="code-header">
        <span data-label-text="Go"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre> <span class="o">...</span>
 <span class="k">var</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Describe</span><span class="p">(</span><span class="s">"Mytest"</span><span class="p">,</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
     <span class="k">var</span> <span class="n">name</span> <span class="kt">string</span><span class="o">=</span> <span class="s">"test"</span>
     <span class="k">var</span> <span class="n">number</span> <span class="kt">int</span><span class="o">=</span> <span class="m">99</span>

     <span class="c">// Spec 1</span>
     <span class="n">Describe</span><span class="p">(</span><span class="s">"Test Greeting function"</span><span class="p">,</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
             <span class="n">Context</span><span class="p">(</span><span class="s">"Giva a name"</span><span class="p">,</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
                 <span class="n">It</span><span class="p">(</span><span class="s">"Should greeting"</span><span class="p">,</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
                     <span class="n">Expect</span><span class="p">(</span><span class="n">Greeting</span><span class="p">(</span><span class="n">name</span><span class="p">))</span><span class="o">.</span><span class="n">To</span><span class="p">(</span><span class="n">Equal</span><span class="p">(</span><span class="s">"Hello "</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s">"."</span><span class="p">))</span>
                 <span class="p">})</span>
             <span class="p">})</span>
     <span class="p">})</span>
     <span class="c">// Spec 2</span>
     <span class="n">Describe</span><span class="p">(</span><span class="s">"Test Calc function"</span><span class="p">,</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
             <span class="n">Context</span><span class="p">(</span><span class="s">"Give a number"</span><span class="p">,</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
                 <span class="n">It</span><span class="p">(</span><span class="s">"Should get the correct result"</span><span class="p">,</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
                     <span class="n">Expect</span><span class="p">(</span><span class="n">Calc</span><span class="p">(</span><span class="n">number</span><span class="p">))</span><span class="o">.</span><span class="n">To</span><span class="p">(</span><span class="n">Equal</span><span class="p">(</span><span class="n">number</span><span class="o">*</span><span class="m">10</span><span class="p">))</span>
                 <span class="p">})</span>
             <span class="p">})</span>
     <span class="p">})</span>
 <span class="p">})</span>

</pre></td></tr></tbody></table></code></div>    </div>

    <p>另一個範例是 Ginkgo 的一個函數 <code class="language-plaintext highlighter-rouge">BeforeEach()</code> ，由於 Kubernetes 的 E2E Test 中使用了很多 BeforeEach ，因此這裡特別解釋一下 BeforeEach  的作用。 BeforeEach 執行時機是在 <code class="language-plaintext highlighter-rouge">每個 Spec 執行前</code> ，我們可以將一些參數初始化的步驟或是一些可能會被 Spec 影響的步驟放到 BeforeEach 裡面，這樣可以確保每次的測試都是公平乾淨且不受影響的。</p>

    <p>從底下例子來看，我們宣告一個 <code class="language-plaintext highlighter-rouge">number</code> 並給它值 <code class="language-plaintext highlighter-rouge">99</code> ， Spec 1 會去執行驗證 <code class="language-plaintext highlighter-rouge">Calc()</code> 函數，驗證完後會把 <code class="language-plaintext highlighter-rouge">number</code> 值改掉，如果沒有把 <code class="language-plaintext highlighter-rouge">number = 99</code> 放到 <code class="language-plaintext highlighter-rouge">BeforeEach()</code> 裡面，那 Spec 2 就會直接使用 <code class="language-plaintext highlighter-rouge">被改過</code> 的 <code class="language-plaintext highlighter-rouge">number</code> ( 這時應該是  <code class="language-plaintext highlighter-rouge">990</code> ) 去做測試，然後就會測失敗，因此必須將 <code class="language-plaintext highlighter-rouge">number = 99</code> 放到 <code class="language-plaintext highlighter-rouge">BeforeEach()</code> 裡面，讓 Ginkgo 執行每個 Spec 之前都重新指派一次 <code class="language-plaintext highlighter-rouge">number</code> 的值。</p>

    <p><code class="language-plaintext highlighter-rouge">mytest2_test.go</code></p>
    <div class="language-go highlighter-rouge"><div class="code-header">
        <span data-label-text="Go"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre> <span class="err">…</span> 
 <span class="k">var</span> <span class="n">_</span> <span class="o">=</span> <span class="n">Describe</span><span class="p">(</span><span class="s">"Mytest"</span><span class="p">,</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
     <span class="k">var</span> <span class="n">number</span> <span class="kt">int</span>
     <span class="c">// 如果將 number 指派放到 BeforeEach 外面，則 number 的值會被 Spec 1 改掉。</span>
     <span class="c">// number = 99</span>

     <span class="n">BeforeEach</span><span class="p">(</span><span class="k">func</span><span class="p">(){</span>
         <span class="c">// 將number 指派放到 BeforeEach 裡面可以確保值永遠都是 99</span>
         <span class="n">number</span>  <span class="o">=</span> <span class="m">99</span>
     <span class="p">})</span>
     <span class="n">Describe</span><span class="p">(</span><span class="s">"Test Calc function again"</span><span class="p">,</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
         <span class="n">Context</span><span class="p">(</span><span class="s">"Give a number 99"</span><span class="p">,</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
             <span class="c">// Spec 1 </span>
             <span class="n">It</span><span class="p">(</span><span class="s">"Should return 990"</span><span class="p">,</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
                 <span class="n">Expect</span><span class="p">(</span><span class="n">Calc</span><span class="p">(</span><span class="n">number</span><span class="p">))</span><span class="o">.</span><span class="n">To</span><span class="p">(</span><span class="n">Equal</span><span class="p">(</span><span class="m">990</span><span class="p">))</span>
                 <span class="n">number</span> <span class="o">=</span> <span class="n">Calc</span><span class="p">(</span><span class="n">number2</span><span class="p">)</span>
             <span class="p">})</span>
             <span class="c">// Spec 2</span>
             <span class="n">It</span><span class="p">(</span><span class="s">"Should return 990, too"</span><span class="p">,</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
                 <span class="n">Expect</span><span class="p">(</span><span class="n">Calc</span><span class="p">(</span><span class="n">number</span><span class="p">))</span><span class="o">.</span><span class="n">To</span><span class="p">(</span><span class="n">Equal</span><span class="p">(</span><span class="m">990</span><span class="p">))</span>
             <span class="p">})</span>
         <span class="p">})</span>
     <span class="p">})</span>
 <span class="p">})</span>   
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>執行測試，我們可以直接使用 <code class="language-plaintext highlighter-rouge">ginkgo</code> 或是 <code class="language-plaintext highlighter-rouge">go test</code> 指令來執行測試。執行完後 Ginkgo 會顯示執行了幾個 Spec ，然後幾個成功幾個失敗。
    <div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>ginkgo
<span class="c"># Show all Specs</span>
<span class="nv">$ </span>ginkgo <span class="nt">-v</span>

Running Suite: Myproject Suite
<span class="o">==============================</span>
Random Seed: 1568041760
Will run 4 of 4 Specs

•••
Ran 4 of 4 Specs <span class="k">in </span>0.001 seconds
SUCCESS! <span class="nt">--</span> 4 Passed | 0 Failed | 0 Pending | 0 Skipped
PASS

Ginkgo ran 1 suite <span class="k">in </span>3.471827325s
Test Suite Passed

</pre></td></tr></tbody></table></code></div>    </div>

    <p>到這邊大概了解 Ginkgo 的作用後，接下來我們回到 <code class="language-plaintext highlighter-rouge">test-infra/kubetest</code> ，根據程式碼來看一下 kubetest 做的事。</p>

    <p>當我們執行 <code class="language-plaintext highlighter-rouge">kubetest --test</code> 的時候， <code class="language-plaintext highlighter-rouge">test-infra/kubetest/main.go</code> 會去執行 <code class="language-plaintext highlighter-rouge">complete()</code> 函數，接著根據指定的 <code class="language-plaintext highlighter-rouge">--deployment</code> 執行 <code class="language-plaintext highlighter-rouge">run(deploy, *o)</code>。</p>

    <p><code class="language-plaintext highlighter-rouge">test-infra/kubetest/main.go</code></p>
    <div class="language-go highlighter-rouge"><div class="code-header">
        <span data-label-text="Go"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="o">...</span>
<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
   <span class="o">...</span>
   <span class="n">err</span> <span class="o">:=</span> <span class="n">complete</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
   <span class="o">...</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">complete</span><span class="p">(</span><span class="n">o</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
   <span class="o">...</span>
   <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">run</span><span class="p">(</span><span class="n">deploy</span><span class="p">,</span> <span class="o">*</span><span class="n">o</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">err</span>
   <span class="p">}</span>
   <span class="o">...</span>
<span class="p">}</span>
<span class="o">...</span>
</pre></td></tr></tbody></table></code></div>    </div>

    <p><code class="language-plaintext highlighter-rouge">test-infra/kubetest/e2e.go</code> 裡的 <code class="language-plaintext highlighter-rouge">run()</code> 函數，會判斷是否有設定 <code class="language-plaintext highlighter-rouge">--test</code> flag，有得話就執行 <code class="language-plaintext highlighter-rouge">Run()</code> 來做 E2E test ，可以看到 <code class="language-plaintext highlighter-rouge">Run()</code> 函數裡會去呼叫 <code class="language-plaintext highlighter-rouge">ginkgo-e2e.sh</code> 。</p>

    <p><code class="language-plaintext highlighter-rouge">test-infra/kubetest/e2e.go</code></p>
    <div class="language-go highlighter-rouge"><div class="code-header">
        <span data-label-text="Go"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre><span class="o">...</span>
<span class="k">func</span> <span class="n">run</span><span class="p">(</span><span class="n">deploy</span> <span class="n">deployer</span><span class="p">,</span> <span class="n">o</span> <span class="n">options</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
   <span class="o">...</span>
   <span class="c">// 判斷是否有設定 --test flag</span>
   <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">test</span> <span class="p">{</span>
      <span class="c">// 判斷是否有 build 了 e2e.test</span>
      <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">control</span><span class="o">.</span><span class="n">XMLWrap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">suite</span><span class="p">,</span> <span class="s">"test setup"</span><span class="p">,</span> <span class="n">deploy</span><span class="o">.</span><span class="n">TestSetup</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
         <span class="o">...</span>
      <span class="p">}</span> 
      <span class="o">...</span>
      <span class="k">else</span> <span class="p">{</span>
         <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">deployment</span> <span class="o">!=</span> <span class="s">"conformance"</span> <span class="p">{</span>
            <span class="o">...</span>
         <span class="p">}</span>
         <span class="o">...</span>
         <span class="k">else</span><span class="p">{</span>
            <span class="o">...</span>
            <span class="k">if</span> <span class="n">tester</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
               <span class="c">// 開始測試</span>
               <span class="k">return</span> <span class="n">tester</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="n">testArgs</span><span class="p">);</span>		
            <span class="p">}</span>
            <span class="o">...</span>
         <span class="p">}</span> 
      <span class="p">}</span>
   <span class="p">}</span>      
<span class="p">}</span>
<span class="o">...</span>

<span class="c">// Run executes ./hack/ginkgo-e2e.sh</span>
<span class="k">func</span> <span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">GinkgoScriptTester</span><span class="p">)</span> <span class="n">Run</span><span class="p">(</span><span class="n">control</span> <span class="o">*</span><span class="n">process</span><span class="o">.</span><span class="n">Control</span><span class="p">,</span> <span class="n">testArgs</span> <span class="p">[]</span><span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
   <span class="k">return</span> <span class="n">control</span><span class="o">.</span><span class="n">FinishRunning</span><span class="p">(</span><span class="n">exec</span><span class="o">.</span><span class="n">Command</span><span class="p">(</span><span class="s">"./hack/ginkgo-e2e.sh"</span><span class="p">,</span> <span class="n">testArgs</span><span class="o">...</span><span class="p">))</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>
    <p>由此可以知道 kubetest 其實是使用 Ginkgo 來執行所有測項，並且會執行 <code class="language-plaintext highlighter-rouge">ginkgo-e2e.sh</code>。</p>
  </li>
</ol>

<h3 id="stage-3-kuberneteshackginkgo-e2esh---kubernetesteste2ee2e_testgo---kubernetesteste2eframeworkframeworkgo"><span class="mr-2">Stage 3: <code class="language-plaintext highlighter-rouge"><span class="mr-2">kubernetes/hack/ginkgo-e2e.sh -&gt; kubernetes/test/e2e/e2e_test.go -&gt; kubernetes/test/e2e/framework/framework.go</code></span><a href="#stage-3-kuberneteshackginkgo-e2esh---kubernetesteste2ee2e_testgo---kubernetesteste2eframeworkframeworkgo" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3>

<p>在 Stage 2 我們已經知道 kubetest 會執行 Ginkgo ， 接下來解釋到底 Test Lists 在哪裡。
我們實際去看 <code class="language-plaintext highlighter-rouge">kubernetes/hack/ginkgo-e2e.sh</code> 原始碼，會看到 Ginkgo 會去執行 <code class="language-plaintext highlighter-rouge">e2e.test</code>。</p>

<p><code class="language-plaintext highlighter-rouge">kubernetes/hack/ginkgo-e2e.sh</code></p>
<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>...
<span class="c"># Find the ginkgo binary build as part of the release.</span>
<span class="nv">ginkgo</span><span class="o">=</span><span class="si">$(</span>kube::util::find-binary <span class="s2">"ginkgo"</span><span class="si">)</span>
<span class="nv">e2e_test</span><span class="o">=</span><span class="si">$(</span>kube::util::find-binary <span class="s2">"e2e.test"</span><span class="si">)</span>

...

<span class="s2">"</span><span class="k">${</span><span class="nv">ginkgo</span><span class="k">}</span><span class="s2">"</span> <span class="s2">"</span><span class="k">${</span><span class="nv">ginkgo_args</span><span class="p">[@]</span>:+<span class="k">${</span><span class="nv">ginkgo_args</span><span class="p">[@]</span><span class="k">}}</span><span class="s2">"</span> <span class="s2">"</span><span class="k">${</span><span class="nv">e2e_test</span><span class="k">}</span><span class="s2">"</span> <span class="nt">--</span> <span class="se">\</span>
  <span class="s2">"</span><span class="k">${</span><span class="nv">auth_config</span><span class="p">[@]</span>:+<span class="k">${</span><span class="nv">auth_config</span><span class="p">[@]</span><span class="k">}}</span><span class="s2">"</span> <span class="se">\</span>
  <span class="nt">--ginkgo</span>.flakeAttempts<span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">FLAKE_ATTEMPTS</span><span class="k">}</span><span class="s2">"</span> <span class="se">\</span>
...
</pre></td></tr></tbody></table></code></div></div>

<p>e2e.test 就是 Test Suite 以及 測項的 Binary 檔，前面我們有提到 <code class="language-plaintext highlighter-rouge">kubetest --build</code> 會去 Build Kubernetes Source Code ，其中一個就是把 <code class="language-plaintext highlighter-rouge">kubernetes/test/e2e</code> Build 成 e2e.test (可參考 <a href="https://github.com/kubernetes/kubernetes/blob/master/test/e2e/BUILD">BUILD</a>)。</p>

<blockquote class="prompt-info"><div>
  <p>這邊 Build 其實就是做 <code class="language-plaintext highlighter-rouge">make</code> 的動作，如果對於 <code class="language-plaintext highlighter-rouge">make</code> 細節有興趣，可以去研究 Kubernetes 目錄裡的 <code class="language-plaintext highlighter-rouge">Makefile</code> 。</p>
</div></blockquote>

<p>我們再回到 kubetest 原始碼來看實際步驟，當執行 <code class="language-plaintext highlighter-rouge">kubetest --build</code> 時，<code class="language-plaintext highlighter-rouge">test-infra/kubetest/main.go</code> 會去執行 <code class="language-plaintext highlighter-rouge">Build()</code> 函數，而這個 <code class="language-plaintext highlighter-rouge">BUild()</code> 函數是位於 <code class="language-plaintext highlighter-rouge">test-infra/kubetest/build.go</code> 裡。</p>

<p><code class="language-plaintext highlighter-rouge">test-infra/kubetest/main.go</code></p>
<div class="language-go highlighter-rouge"><div class="code-header">
        <span data-label-text="Go"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="k">func</span> <span class="n">acquireKubernetes</span><span class="p">(</span><span class="n">o</span> <span class="o">*</span><span class="n">options</span><span class="p">,</span> <span class="n">d</span> <span class="n">deployer</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
   <span class="c">// Potentially build kubernetes</span>
   <span class="c">// 判斷有沒有設定 --build flag</span>
	<span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">Enabled</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">var</span> <span class="n">err</span> <span class="kt">error</span>
		<span class="c">// kind deployer manages build</span>
		<span class="k">if</span> <span class="n">k</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">kind</span><span class="o">.</span><span class="n">Deployer</span><span class="p">);</span> <span class="n">ok</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">control</span><span class="o">.</span><span class="n">XMLWrap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">suite</span><span class="p">,</span> <span class="s">"Build"</span><span class="p">,</span> <span class="n">k</span><span class="o">.</span><span class="n">Build</span><span class="p">)</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="c">// o.build.Build 就是 kubetest --build="值" 指定的值，如果沒指定</span>
         <span class="c">// 預設是  quick-release</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">control</span><span class="o">.</span><span class="n">XMLWrap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">suite</span><span class="p">,</span> <span class="s">"Build"</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">build</span><span class="o">.</span><span class="n">Build</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="o">...</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p><code class="language-plaintext highlighter-rouge">Build()</code> 函數會實際去執行 <code class="language-plaintext highlighter-rouge">make</code> 來 Build Source Code 。</p>

<p><code class="language-plaintext highlighter-rouge">test-infra/kubetest/build.go</code></p>
<div class="language-go highlighter-rouge"><div class="code-header">
        <span data-label-text="Go"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="k">func</span> <span class="p">(</span><span class="n">b</span> <span class="o">*</span><span class="n">buildStrategy</span><span class="p">)</span> <span class="n">Build</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="k">var</span> <span class="n">target</span> <span class="kt">string</span>
	<span class="k">switch</span> <span class="o">*</span><span class="n">b</span> <span class="p">{</span>
	<span class="k">case</span> <span class="s">"bazel"</span><span class="o">:</span>
		<span class="n">target</span> <span class="o">=</span> <span class="s">"bazel-release"</span>
	<span class="k">case</span> <span class="s">"e2e"</span><span class="o">:</span>
		<span class="c">//TODO(Q-Lee): we should have a better way of build just the e2e tests</span>
		<span class="n">target</span> <span class="o">=</span> <span class="s">"bazel-release"</span>
      <span class="o">...</span>
	<span class="k">case</span> <span class="s">"host-go"</span><span class="o">:</span>
		<span class="n">target</span> <span class="o">=</span> <span class="s">"all"</span>
	<span class="k">case</span> <span class="s">"quick"</span><span class="o">:</span>
		<span class="n">target</span> <span class="o">=</span> <span class="s">"quick-release"</span>
	<span class="k">case</span> <span class="s">"release"</span><span class="o">:</span>
		<span class="n">target</span> <span class="o">=</span> <span class="s">"release"</span>
	<span class="k">case</span> <span class="s">"gce-windows-bazel"</span><span class="o">:</span>
		<span class="o">...</span>
	<span class="k">default</span><span class="o">:</span>
		<span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"Unknown build strategy: %v"</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
	<span class="p">}</span>
   <span class="o">...</span>

	<span class="c">// 執行 make -C kubernetes &lt;target&gt;</span>
	<span class="k">return</span> <span class="n">control</span><span class="o">.</span><span class="n">FinishRunning</span><span class="p">(</span><span class="n">exec</span><span class="o">.</span><span class="n">Command</span><span class="p">(</span><span class="s">"make"</span><span class="p">,</span> <span class="s">"-C"</span><span class="p">,</span> <span class="n">util</span><span class="o">.</span><span class="n">K8s</span><span class="p">(</span><span class="s">"kubernetes"</span><span class="p">),</span> <span class="n">target</span><span class="p">))</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>到這邊我們已經知道 <code class="language-plaintext highlighter-rouge">kubetest --build</code> 執行細節以及 e2e.test 的由來，接下來我們再討論 e2e.test 裡的 Test Suite 以及 Spec 到底是什麼？</p>

<h2 id="test-suite"><span class="mr-2">Test Suite</span><a href="#test-suite" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2>
<p>前面有提到 Golang 在執行 <code class="language-plaintext highlighter-rouge">go test</code> 時會去找 <code class="language-plaintext highlighter-rouge">xxx_test.go</code> 的檔案，並且執行裡面的 <code class="language-plaintext highlighter-rouge">Testxxx()</code> 函數。因此當 Ginkgo 執行 e2e.test 時，會找到 <code class="language-plaintext highlighter-rouge">kubernetes/test/e2e/e2e_test.go</code> 檔，然後去執行 <code class="language-plaintext highlighter-rouge">kubernetes/test/e2e/e2e.go</code> 裡面的 <code class="language-plaintext highlighter-rouge">TestE2E()</code> 函數。</p>

<p><code class="language-plaintext highlighter-rouge">kubernetes/test/e2e/e2e_test.go</code></p>
<div class="language-go highlighter-rouge"><div class="code-header">
        <span data-label-text="Go"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="k">func</span> <span class="n">TestE2E</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">RunE2ETests</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p><code class="language-plaintext highlighter-rouge">TestE2E()</code> 函數會執行 Ginkgo 函數 <code class="language-plaintext highlighter-rouge">RunSpec()</code> 來執行所有 Spec，由此可以知道 e2e_test.go 以及 e2e.go 就是 Test Suite 。</p>

<p><code class="language-plaintext highlighter-rouge">kubernetes/test/e2e/e2e.go</code></p>
<div class="language-go highlighter-rouge"><div class="code-header">
        <span data-label-text="Go"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="k">func</span> <span class="n">RunE2ETests</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
   <span class="o">...</span>
   <span class="n">ginkgo</span><span class="o">.</span><span class="n">RunSpecsWithDefaultAndCustomReporters</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s">"Kubernetes e2e suite"</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>
<h2 id="specs"><span class="mr-2">Specs</span><a href="#specs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2>
<p>一般來說使用 Ginkgo 來做測試，為了方便 Test Suite 去抓到所有的 Spec ，會在 Test Suite 檔案 Import Spec 的 {ackage (除非 Spec 與 Test Suite 同個 Package )，所以如果直接從 e2e_test.go 以及 e2e.go 去看，就會發現在 e2e_test.go 裡 Import 了所有 E2E Test 用到的 Spec ，可以發現這些測項就是位於 <code class="language-plaintext highlighter-rouge">kubernetes/test/e2e/</code> 底下。</p>

<p><code class="language-plaintext highlighter-rouge">kubernetes/test/e2e/e2e_test.go</code></p>
<div class="language-go highlighter-rouge"><div class="code-header">
        <span data-label-text="Go"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre><span class="k">package</span> <span class="n">e2e</span>

<span class="k">import</span> <span class="p">(</span>
   <span class="s">"flag"</span>
   <span class="o">...</span>

   <span class="c">// test sources</span>
	<span class="n">_</span> <span class="s">"k8s.io/kubernetes/test/e2e/apimachinery"</span>
	<span class="n">_</span> <span class="s">"k8s.io/kubernetes/test/e2e/apps"</span>
	<span class="n">_</span> <span class="s">"k8s.io/kubernetes/test/e2e/auth"</span>
	<span class="n">_</span> <span class="s">"k8s.io/kubernetes/test/e2e/autoscaling"</span>
	<span class="n">_</span> <span class="s">"k8s.io/kubernetes/test/e2e/cloud"</span>
	<span class="n">_</span> <span class="s">"k8s.io/kubernetes/test/e2e/common"</span>
	<span class="n">_</span> <span class="s">"k8s.io/kubernetes/test/e2e/instrumentation"</span>
	<span class="n">_</span> <span class="s">"k8s.io/kubernetes/test/e2e/kubectl"</span>
	<span class="n">_</span> <span class="s">"k8s.io/kubernetes/test/e2e/lifecycle"</span>
	<span class="n">_</span> <span class="s">"k8s.io/kubernetes/test/e2e/lifecycle/bootstrap"</span>
	<span class="n">_</span> <span class="s">"k8s.io/kubernetes/test/e2e/network"</span>
	<span class="n">_</span> <span class="s">"k8s.io/kubernetes/test/e2e/node"</span>
	<span class="n">_</span> <span class="s">"k8s.io/kubernetes/test/e2e/scheduling"</span>
	<span class="n">_</span> <span class="s">"k8s.io/kubernetes/test/e2e/servicecatalog"</span>
	<span class="n">_</span> <span class="s">"k8s.io/kubernetes/test/e2e/storage"</span>
	<span class="n">_</span> <span class="s">"k8s.io/kubernetes/test/e2e/storage/external"</span>
	<span class="n">_</span> <span class="s">"k8s.io/kubernetes/test/e2e/ui"</span>
	<span class="n">_</span> <span class="s">"k8s.io/kubernetes/test/e2e/windows"</span>
<span class="p">)</span>
<span class="o">...</span>
</pre></td></tr></tbody></table></code></div></div>

<p>從裡面挑了一個 Spec 來看，可以看到 Spec 格式就是使用 Ginkgo 以及 Gomega 寫出來的。</p>

<p><code class="language-plaintext highlighter-rouge">kubernetes/test/e2e/ui/dashboard.go</code></p>
<div class="language-go highlighter-rouge"><div class="code-header">
        <span data-label-text="Go"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre></td><td class="rouge-code"><pre><span class="k">package</span> <span class="n">ui</span>
<span class="o">...</span>

<span class="k">var</span> <span class="n">_</span> <span class="o">=</span> <span class="n">SIGDescribe</span><span class="p">(</span><span class="s">"Kubernetes Dashboard [Feature:Dashboard]"</span><span class="p">,</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">ginkgo</span><span class="o">.</span><span class="n">BeforeEach</span><span class="p">(</span><span class="k">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="c">// TODO(kubernetes/kubernetes#61559): Enable dashboard here rather than skip the test.</span>
		<span class="n">framework</span><span class="o">.</span><span class="n">SkipIfProviderIs</span><span class="p">(</span><span class="s">"gke"</span><span class="p">)</span>
	<span class="p">})</span>

	<span class="k">const</span> <span class="p">(</span>
		<span class="n">uiServiceName</span> <span class="o">=</span> <span class="s">"kubernetes-dashboard"</span>
		<span class="n">uiAppName</span>     <span class="o">=</span> <span class="n">uiServiceName</span>
		<span class="n">uiNamespace</span>   <span class="o">=</span> <span class="n">metav1</span><span class="o">.</span><span class="n">NamespaceSystem</span>

		<span class="n">serverStartTimeout</span> <span class="o">=</span> <span class="m">1</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Minute</span>
	<span class="p">)</span>

	<span class="n">f</span> <span class="o">:=</span> <span class="n">framework</span><span class="o">.</span><span class="n">NewDefaultFramework</span><span class="p">(</span><span class="n">uiServiceName</span><span class="p">)</span>

	<span class="n">ginkgo</span><span class="o">.</span><span class="n">It</span><span class="p">(</span><span class="s">"should check that the kubernetes-dashboard instance is alive"</span><span class="p">,</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="n">ginkgo</span><span class="o">.</span><span class="n">By</span><span class="p">(</span><span class="s">"Checking whether the kubernetes-dashboard service exists."</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">:=</span> <span class="n">framework</span><span class="o">.</span><span class="n">WaitForService</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">ClientSet</span><span class="p">,</span> <span class="n">uiNamespace</span><span class="p">,</span> <span class="n">uiServiceName</span><span class="p">,</span> <span class="no">true</span><span class="p">,</span> <span class="n">framework</span><span class="o">.</span><span class="n">Poll</span><span class="p">,</span> <span class="n">framework</span><span class="o">.</span><span class="n">ServiceStartTimeout</span><span class="p">)</span>
		<span class="n">framework</span><span class="o">.</span><span class="n">ExpectNoError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

		<span class="n">ginkgo</span><span class="o">.</span><span class="n">By</span><span class="p">(</span><span class="s">"Checking to make sure the kubernetes-dashboard pods are running"</span><span class="p">)</span>
		<span class="n">selector</span> <span class="o">:=</span> <span class="n">Labels</span><span class="o">.</span><span class="n">SelectorFromSet</span><span class="p">(</span><span class="n">Labels</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span><span class="s">"k8s-app"</span><span class="o">:</span> <span class="n">uiAppName</span><span class="p">}))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">testutils</span><span class="o">.</span><span class="n">WaitForPodsWithLabelRunning</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">ClientSet</span><span class="p">,</span> <span class="n">uiNamespace</span><span class="p">,</span> <span class="n">selector</span><span class="p">)</span>
		<span class="n">framework</span><span class="o">.</span><span class="n">ExpectNoError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>

		<span class="n">ginkgo</span><span class="o">.</span><span class="n">By</span><span class="p">(</span><span class="s">"Checking to make sure we get a response from the kubernetes-dashboard."</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">wait</span><span class="o">.</span><span class="n">Poll</span><span class="p">(</span><span class="n">framework</span><span class="o">.</span><span class="n">Poll</span><span class="p">,</span> <span class="n">serverStartTimeout</span><span class="p">,</span> <span class="k">func</span><span class="p">()</span> <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">var</span> <span class="n">status</span> <span class="kt">int</span>
			<span class="n">proxyRequest</span><span class="p">,</span> <span class="n">errProxy</span> <span class="o">:=</span> <span class="n">e2eservice</span><span class="o">.</span><span class="n">GetServicesProxyRequest</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">ClientSet</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">ClientSet</span><span class="o">.</span><span class="n">CoreV1</span><span class="p">()</span><span class="o">.</span><span class="n">RESTClient</span><span class="p">()</span><span class="o">.</span><span class="n">Get</span><span class="p">())</span>
			<span class="k">if</span> <span class="n">errProxy</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
				<span class="n">framework</span><span class="o">.</span><span class="n">Logf</span><span class="p">(</span><span class="s">"Get services proxy request failed: %v"</span><span class="p">,</span> <span class="n">errProxy</span><span class="p">)</span>
			<span class="p">}</span>

			<span class="n">ctx</span><span class="p">,</span> <span class="n">cancel</span> <span class="o">:=</span> <span class="n">context</span><span class="o">.</span><span class="n">WithTimeout</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">Background</span><span class="p">(),</span> <span class="n">framework</span><span class="o">.</span><span class="n">SingleCallTimeout</span><span class="p">)</span>
			<span class="k">defer</span> <span class="n">cancel</span><span class="p">()</span>

			<span class="c">// Query against the proxy URL for the kubernetes-dashboard service.</span>
			<span class="n">err</span> <span class="o">:=</span> <span class="n">proxyRequest</span><span class="o">.</span><span class="n">Namespace</span><span class="p">(</span><span class="n">uiNamespace</span><span class="p">)</span><span class="o">.</span>
				<span class="n">Context</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span><span class="o">.</span>
				<span class="n">Name</span><span class="p">(</span><span class="n">utilnet</span><span class="o">.</span><span class="n">JoinSchemeNamePort</span><span class="p">(</span><span class="s">"https"</span><span class="p">,</span> <span class="n">uiServiceName</span><span class="p">,</span> <span class="s">""</span><span class="p">))</span><span class="o">.</span>
				<span class="n">Timeout</span><span class="p">(</span><span class="n">framework</span><span class="o">.</span><span class="n">SingleCallTimeout</span><span class="p">)</span><span class="o">.</span>
				<span class="n">Do</span><span class="p">()</span><span class="o">.</span>
				<span class="n">StatusCode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">)</span><span class="o">.</span>
				<span class="n">Error</span><span class="p">()</span>
			<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
				<span class="k">if</span> <span class="n">ctx</span><span class="o">.</span><span class="n">Err</span><span class="p">()</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
					<span class="n">framework</span><span class="o">.</span><span class="n">Failf</span><span class="p">(</span><span class="s">"Request to kubernetes-dashboard failed: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
					<span class="k">return</span> <span class="no">true</span><span class="p">,</span> <span class="n">err</span>
				<span class="p">}</span>
				<span class="n">framework</span><span class="o">.</span><span class="n">Logf</span><span class="p">(</span><span class="s">"Request to kubernetes-dashboard failed: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="n">http</span><span class="o">.</span><span class="n">StatusOK</span> <span class="p">{</span>
				<span class="n">framework</span><span class="o">.</span><span class="n">Logf</span><span class="p">(</span><span class="s">"Unexpected status from kubernetes-dashboard: %v"</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
			<span class="p">}</span>
			<span class="c">// Don't return err here as it aborts polling.</span>
			<span class="k">return</span> <span class="n">status</span> <span class="o">==</span> <span class="n">http</span><span class="o">.</span><span class="n">StatusOK</span><span class="p">,</span> <span class="no">nil</span>
		<span class="p">})</span>
		<span class="n">framework</span><span class="o">.</span><span class="n">ExpectNoError</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
	<span class="p">})</span>
<span class="p">})</span>
</pre></td></tr></tbody></table></code></div></div>
<blockquote class="prompt-info"><div>
  <p>此 Spec 是檢查 kubernetes dashboard 是否正常執行</p>
</div></blockquote>

<h2 id="kind-of-tests"><span class="mr-2">Kind of Tests</span><a href="#kind-of-tests" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2>
<p>從前面小節我們得知 Kubernetes E2E Testing 的測項，但是這些測項非常的多，要如何區別這些測項呢? Kubernetes 針對這部份採用了賦予 Label 的方式來區別不同種類的測項。</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">[Slow]</code> - 執行時間超過兩分鐘的測項。</li>
  <li><code class="language-plaintext highlighter-rouge">[Serial]</code> - 需要依序執行，而不能平行執行的測項。</li>
  <li><code class="language-plaintext highlighter-rouge">[Disruptive]</code> - 具有破壞性或是會影響其他測試的測項，例如重開機 node ，或是砍掉 <code class="language-plaintext highlighter-rouge">kube-system</code> 相關的 pod 等等。</li>
  <li><code class="language-plaintext highlighter-rouge">[Internet]</code> - 會需要連到外部網路的測項。</li>
  <li><code class="language-plaintext highlighter-rouge">[Conformance]</code> - Conformace Testing 的測項。</li>
  <li><code class="language-plaintext highlighter-rouge">[LinuxOnly]</code> - 只能跑在 Linux node 的測項。</li>
  <li><code class="language-plaintext highlighter-rouge">[Privileged]</code> - 會需要 privileged container 的測項。</li>
  <li><code class="language-plaintext highlighter-rouge">[Alpha]</code> - 測試 Alpha 功能的測項。
…</li>
</ul>

<p>詳細 Label 資訊可以參考 - <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-testing/e2e-tests.md#kinds-of-tests">Kinds of tests</a></p>

<p>一個測項 ( Spec ) 可以貼上一個或是多個 Label ，貼的位置可以在 <code class="language-plaintext highlighter-rouge">SIGDescribe</code> 或是 <code class="language-plaintext highlighter-rouge">Ginkgo.It</code> ，如以下範例：</p>
<div class="language-go highlighter-rouge"><div class="code-header">
        <span data-label-text="Go"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="n">ginkgo</span><span class="o">.</span><span class="n">It</span><span class="p">(</span><span class="s">"should provide Internet connection for containers [Feature:Networking-IPv6][Experimental][LinuxOnly]"</span><span class="p">,</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="c">// IPv6 is not supported on Windows.</span>
		<span class="n">framework</span><span class="o">.</span><span class="n">SkipIfNodeOSDistroIs</span><span class="p">(</span><span class="s">"windows"</span><span class="p">)</span>
		<span class="n">ginkgo</span><span class="o">.</span><span class="n">By</span><span class="p">(</span><span class="s">"Running container which tries to connect to 2001:4860:4860::8888"</span><span class="p">)</span>
		<span class="n">framework</span><span class="o">.</span><span class="n">ExpectNoError</span><span class="p">(</span>
			<span class="n">framework</span><span class="o">.</span><span class="n">CheckConnectivityToHost</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="s">"connectivity-test"</span><span class="p">,</span> <span class="s">"2001:4860:4860::8888"</span><span class="p">,</span> <span class="m">53</span><span class="p">,</span> <span class="m">30</span><span class="p">))</span>
<span class="p">})</span>
<span class="o">...</span>
</pre></td></tr></tbody></table></code></div></div>
<div class="language-go highlighter-rouge"><div class="code-header">
        <span data-label-text="Go"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="k">var</span> <span class="n">_</span> <span class="o">=</span> <span class="n">SIGDescribe</span><span class="p">(</span><span class="s">"Kubernetes Dashboard [Feature:Dashboard]"</span><span class="p">,</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">ginkgo</span><span class="o">.</span><span class="n">BeforeEach</span><span class="p">(</span><span class="k">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="n">framework</span><span class="o">.</span><span class="n">SkipIfProviderIs</span><span class="p">(</span><span class="s">"gke"</span><span class="p">)</span>
   <span class="p">})</span>
<span class="o">...</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="execute-specific-kind-of-tests"><span class="mr-2">Execute Specific Kind of Tests</span><a href="#execute-specific-kind-of-tests" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2>
<p>在 kubetest 使用上，要過濾或是執行特定的測項，只需要使用 <code class="language-plaintext highlighter-rouge">--test_args</code> flag 然後裡面再設定 <code class="language-plaintext highlighter-rouge">--ginkgo.focus/skip</code> 就可以了。<code class="language-plaintext highlighter-rouge">--test_args</code> 是讓 kubetest 可以使用 Ginkgo CLI 的 flag ，因此不單單可以用 <code class="language-plaintext highlighter-rouge">focus/skip</code> ，只要是 Ginkgo CLI 支援的 flag ，基本上都可以使用。<code class="language-plaintext highlighter-rouge">focus/skip</code> 可以透過正規表示式來比對 <code class="language-plaintext highlighter-rouge">Describe</code> 或是 <code class="language-plaintext highlighter-rouge">ginkgo.It</code> 描述裡的 Label。</p>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="c"># Only execute tests with LinuxOnly Label.</span>
<span class="nv">$ </span>kubetest <span class="nt">--test</span> <span class="nt">--test_args</span><span class="o">=</span><span class="s2">"--ginkgo.focus=</span><span class="se">\[</span><span class="s2">LinuxOnly</span><span class="se">\]</span><span class="s2">"</span> <span class="nt">--provider</span> <span class="nb">local</span> <span class="nt">--deployment</span> <span class="nb">local</span>

<span class="c"># Skip the tests with LinuxOnly Label.</span>
<span class="nv">$ </span>kubetest <span class="nt">--test</span> <span class="nt">--test_args</span><span class="o">=</span><span class="s2">"--ginkgo.skip=</span><span class="se">\[</span><span class="s2">LinuxOnly</span><span class="se">\]</span><span class="s2">"</span> <span class="nt">--provider</span> <span class="nb">local</span> <span class="nt">--deployment</span> <span class="nb">local</span>
</pre></td></tr></tbody></table></code></div></div>
<blockquote class="prompt-info"><div>
  <p>focus/skip 可以用來比對 Describe 或是 ginkgo.It 描述裡的 Label。</p>
</div></blockquote>

<h2 id="frameworkgo"><span class="mr-2">framework.go</span><a href="#frameworkgo" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2>
<p><code class="language-plaintext highlighter-rouge">kubernetes/test/e2e/framework/framework.go</code> 是用來執行一些 E2E test 會使用到的函數，如後續會提到的 Conformance Testing 就是在 framework.go 裡執行 <code class="language-plaintext highlighter-rouge">framework.ConformanceIt()</code> 來做貼 Label 的動作。其餘 framework.go 細節筆者就沒深入去瞭解，因此這部分就不深入解釋。</p>

<h1 id="write-your-own-test">Write Your Own Test</h1>
<p>在了解 kubetest 流程之後，接下來我們來試著撰寫自己的測試。</p>

<h2 id="specifications"><span class="mr-2">Specifications</span><a href="#specifications" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2>
<p>Kubernetes Community 在 <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-testing/writing-good-e2e-tests.md">Writing good e2e tests for Kubernetes</a> 裡提到一些撰寫測試前需要注意的事項以及一些規範，大致為以下幾項：</p>

<ul>
  <li>
    <p><strong>Debuggability</strong> : 在寫測試時盡量將所有訊息寫清楚，例如測試失敗時，失敗訊息要寫明確說是哪裡錯誤，不要就含糊的顯示「測試失敗」之類的訊息，必須讓測試人員容易去 Debug 。</p>
  </li>
  <li>
    <p><strong>Ability to run in non-dedicated test clusters</strong> :  不要限定測試只能跑在<code class="language-plaintext highlighter-rouge">特定</code>的 Cluster，這裡的意思是撰寫測試時不要有<code class="language-plaintext highlighter-rouge">假設</code>的情況，任何測項都要寫清楚。例如：假設這個 Cluster 是乾淨的，上面沒有跑任何服務、假設環境裡已經有 xxx 服務或是假設 Cluster 跑在什麼硬體、環境等等。這裡官方舉了一個例子: 假如今天寫了一個測試「確認你的 Pod 能跑在所有 Node 上」來驗證所有 Node 有沒有問題，這個測項看起來似乎沒問題，但是實際上做了一個「同時間內只有你這個測項跑在 Node 上或是同時間沒有其他服務在 Node 上」的假設。假如你在跑這項測試前， Cluster 正在同時跑其他測試(或是服務)，導致某個 Node 資源被佔滿或是執行到 <code class="language-plaintext highlighter-rouge">[Disruptive]</code> 的測項，這樣這個測試就會被影響而失敗，但是他的失敗並不是 Node 本身有問題，而是被其他東西影響，這樣測試出來就會不準確。</p>

    <p>另外是盡量避免撰寫 <code class="language-plaintext highlighter-rouge">[Disruptive]</code> 的測項，我們前面有提到 <code class="language-plaintext highlighter-rouge">[Disruptive]</code> 是具破壞性的測項，可能會影響其他測試，例如：重開機、刪掉服務等等。這裡避免的意思一樣是不要假設：「同時間只有你這個測項在測試」，避免影響到其他測試或服務，如果真的要撰寫該類型的測試，一定要加 <code class="language-plaintext highlighter-rouge">[Disruptive]</code> Label，並且把測項描述寫清楚。</p>

    <p>最後是盡量不要使用非 Kubernetes 官方的 API 來做測試，因為這樣測試失敗時很難找出是 API 問題還是 Cluster 問題。</p>
  </li>
  <li>
    <p><strong>Speed of execution</strong> : 在寫測試時，盡量提升測試的效率、壓低測試的時間，不要放一些如 <code class="language-plaintext highlighter-rouge">sleep</code> 這種耗時間的函數，如果測試時間會超過兩分鐘以上就加上 <code class="language-plaintext highlighter-rouge">[Slow]</code> Label，讓測試者知道這個是比較耗時的測項。</p>

    <p>另外除了測試花的時間之外，還必須設定好測試失敗的時間，例如：你的測試很簡單只需要兩分鐘內完成，但是可能光是等 Pod Ready 就等超過兩分鐘甚至是 Pod 已經卡住了，如果沒有設定測試失敗的時間 (如10分鐘後就認定測試失敗) ，這個測試就會永遠卡在那。</p>
  </li>
  <li>
    <p><strong>Resilience to relatively rare, temporary infrastructure glitches or delays</strong> : 在寫測試時，要彈性一點，當遇到失敗的情況，多試幾次，有可能只是剛好一些情況導致失敗。舉例來說：你的測項是 「測試 Cluster 能不能跑起來 Nginx 的 Pod 」，有可能第一次在測剛好網路比較不穩， Image 抓比較慢或是抓不下來，導致測試失敗，但是第二次網路就恢復重抓就抓下來了，因此不要在第一次失敗就直接認定測試失敗，過個幾秒再重抓 Image 一次，測試就會正常了。</p>
  </li>
</ul>

<blockquote class="prompt-tip"><div>
  <p>這裡需要注意的是，雖然說要給測項一些彈性，不過也是要根據你的測項來判斷適不適用。</p>
</div></blockquote>

<h2 id="add-new-test"><span class="mr-2">Add New Test</span><a href="#add-new-test" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2>
<p>了解測試撰寫規範之後，接下來就來實際撰寫測試，以下範例可以從我的 GitHub - <a href="https://github.com/pohsienshih/kubernetes-e2e-practice">kubernetes-e2e-practice</a> 裡取得，有興趣者，可以載下來測試。</p>

<blockquote class="prompt-tip"><div>
  <p>該範例適用於 Kubernetes v1.15.x 版本</p>
</div></blockquote>

<p>在這個範例裡， 我們會撰寫一個小測試驗證是否能在 Cluster 部署一個名為 <code class="language-plaintext highlighter-rouge">pohsien</code> 的 Pod ，並確認這個 Pod 是否成功執行起來。</p>

<ol>
  <li>首先在 <code class="language-plaintext highlighter-rouge">kubernetes/test/e2e</code> 新增一個 <code class="language-plaintext highlighter-rouge">pohsien</code> 資料夾，裡面就是放置我們自己撰寫的測試檔。
    <div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">mkdir</span> <span class="nt">-c</span> kubernetes/test/e2e/pohsien
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>接著撰寫自己的測試，並放置在剛剛建立的 <code class="language-plaintext highlighter-rouge">kubernetes/test/e2e/pohsien/</code> 裡面，基本上這邊都是使用 <a href="https://github.com/kubernetes/client-go">client-go</a> 來操作 Kubernetes 資源。我們定義一個 <code class="language-plaintext highlighter-rouge">[Pohsien]</code> Label ，然後把我們的測項貼上這個 Label ，以方便之後執行測試。
    <div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>vim kubernetes/test/e2e/pohsien/pohsien.go
<span class="nv">$ </span>vim kubernetes/test/e2e/pohsien/framework.go
</pre></td></tr></tbody></table></code></div>    </div>

    <p><code class="language-plaintext highlighter-rouge">pohsien.go</code></p>
    <div class="language-go highlighter-rouge"><div class="code-header">
        <span data-label-text="Go"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="rouge-code"><pre> <span class="k">package</span> <span class="n">pohsien</span>
 <span class="o">...</span>
 <span class="k">var</span> <span class="n">_</span> <span class="o">=</span> <span class="n">SIGDescribe</span><span class="p">(</span><span class="s">"Kubernetes Pohsien's Pod [Pohsien]"</span><span class="p">,</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
         <span class="n">f</span> <span class="o">:=</span> <span class="n">framework</span><span class="o">.</span><span class="n">NewDefaultFramework</span><span class="p">(</span><span class="s">"pods"</span><span class="p">)</span>
         <span class="k">var</span> <span class="n">podClient</span> <span class="o">*</span><span class="n">framework</span><span class="o">.</span><span class="n">PodClient</span>
                 <span class="n">ginkgo</span><span class="o">.</span><span class="n">BeforeEach</span><span class="p">(</span><span class="k">func</span><span class="p">()</span> <span class="p">{</span>
                 <span class="n">podClient</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">PodClient</span><span class="p">()</span>
         <span class="p">})</span>

         <span class="n">ginkgo</span><span class="o">.</span><span class="n">It</span><span class="p">(</span><span class="s">"Make sure the pohsien pod can be deployed"</span><span class="p">,</span> <span class="k">func</span><span class="p">(){</span>
             <span class="c">// 建立 pod </span>
             <span class="n">ginkgo</span><span class="o">.</span><span class="n">By</span><span class="p">(</span><span class="s">"Create Pod"</span><span class="p">)</span>
             <span class="n">pod</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">corev1</span><span class="o">.</span><span class="n">Pod</span><span class="p">{</span>
                         <span class="n">ObjectMeta</span><span class="o">:</span> <span class="n">metav1</span><span class="o">.</span><span class="n">ObjectMeta</span><span class="p">{</span>
                                 <span class="n">Name</span><span class="o">:</span> <span class="s">"pohsien"</span><span class="p">,</span>
                                 <span class="n">Labels</span><span class="o">:</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
                                         <span class="s">"name"</span><span class="o">:</span> <span class="s">"pohsien"</span><span class="p">,</span>
                                 <span class="p">},</span>
                         <span class="p">},</span>
                         <span class="n">Spec</span><span class="o">:</span> <span class="n">corev1</span><span class="o">.</span><span class="n">PodSpec</span><span class="p">{</span>
                                 <span class="n">Containers</span><span class="o">:</span> <span class="p">[]</span><span class="n">corev1</span><span class="o">.</span><span class="n">Container</span><span class="p">{</span>
                                         <span class="p">{</span>
                                                 <span class="n">Name</span><span class="o">:</span>  <span class="s">"nginx"</span><span class="p">,</span>
                                                 <span class="n">Image</span><span class="o">:</span> <span class="s">"nginx:1.17.3"</span><span class="p">,</span>
                                         <span class="p">},</span>
                                 <span class="p">},</span>
                         <span class="p">},</span>
                 <span class="p">}</span>
             <span class="n">podClient</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">pod</span><span class="p">)</span>
                
             <span class="c">// 檢查 pod 是否成功運行起來</span>
             <span class="n">ginkgo</span><span class="o">.</span><span class="n">By</span><span class="p">(</span><span class="s">"Get the pod"</span><span class="p">)</span>
                 <span class="n">podGetting</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">podClient</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">pod</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">metav1</span><span class="o">.</span><span class="n">GetOptions</span><span class="p">{})</span>
             <span class="n">framework</span><span class="o">.</span><span class="n">ExpectNoError</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="s">"Failed to get the pod"</span><span class="p">)</span>
             <span class="n">framework</span><span class="o">.</span><span class="n">ExpectNoError</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">WaitForPodRunning</span><span class="p">(</span><span class="n">podGetting</span><span class="o">.</span><span class="n">Name</span><span class="p">))</span>
             <span class="n">gomega</span><span class="o">.</span><span class="n">Expect</span><span class="p">(</span><span class="n">podGetting</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="s">"pohsien"</span><span class="p">)</span>

         <span class="p">})</span>
 <span class="p">})</span>
</pre></td></tr></tbody></table></code></div>    </div>

    <p>framework.go 是用來宣告 <code class="language-plaintext highlighter-rouge">SIGDescribe()</code> 函數，而其他的測試檔會呼叫這個函數並且傳遞相關參數(例如要設定的 Label 以及 Spec 等等），一般來說會在 framework.go 設定一些 Global 的設定或變數，例如幫整個該資料夾的測項貼上對應的 SIG Label。雖然 framework.go 應該不是必要的，但是為了與其他測項一致，因此在此範例我們也新增了 framework.go ，並且加上了我們虛構的 <code class="language-plaintext highlighter-rouge">[pohsien-testing]</code> Label 。
 <code class="language-plaintext highlighter-rouge">framework.go</code></p>
    <div class="language-go highlighter-rouge"><div class="code-header">
        <span data-label-text="Go"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre> <span class="k">package</span> <span class="n">pohsien</span>

 <span class="k">import</span> <span class="s">"github.com/onsi/ginkgo"</span>

 <span class="c">// SIGDescribe annotates the test with the SIG Label.</span>
 <span class="k">func</span> <span class="n">SIGDescribe</span><span class="p">(</span><span class="n">text</span> <span class="kt">string</span><span class="p">,</span> <span class="n">body</span> <span class="k">func</span><span class="p">())</span> <span class="kt">bool</span> <span class="p">{</span>
     <span class="k">return</span> <span class="n">ginkgo</span><span class="o">.</span><span class="n">Describe</span><span class="p">(</span><span class="s">"[pohsien-testing] "</span><span class="o">+</span><span class="n">text</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
 <span class="p">}</span>
</pre></td></tr></tbody></table></code></div>    </div>
    <p>由於我們範例只是 Demo 用，因此在這裡並沒有特別嚴謹的指定 Label ，但請記得在撰寫自己的測試時一定要加上對應 Label ，如 <code class="language-plaintext highlighter-rouge">[Slow]</code> 、 <code class="language-plaintext highlighter-rouge">[Serial]</code> 、 <code class="language-plaintext highlighter-rouge">[Disruptive]</code> 等等，這樣可以讓測試人員更加了解你的測項的特性，如果不確定要加上哪些 Label 可以在 slack 或是 發佈 Issue / PR 時，標註 <code class="language-plaintext highlighter-rouge">#kinds-of-tests</code> 來詢問。</p>
  </li>
  <li>接下來在 <code class="language-plaintext highlighter-rouge">kubernetes/test/e2e/e2e_test.go</code> 裡面 Import 我們自己的測項。
<code class="language-plaintext highlighter-rouge">framework.go</code>
    <div class="language-go highlighter-rouge"><div class="code-header">
        <span data-label-text="Go"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="k">package</span> <span class="n">e2e</span>

<span class="k">import</span> <span class="p">(</span>
   <span class="s">"flag"</span>
   <span class="s">"fmt"</span>
   <span class="o">...</span>

   <span class="c">// test sources</span>
   <span class="n">_</span> <span class="s">"k8s.io/kubernetes/test/e2e/apimachinery"</span>
   <span class="n">_</span> <span class="s">"k8s.io/kubernetes/test/e2e/apps"</span>
   <span class="o">...</span>
   <span class="n">_</span> <span class="s">"k8s.io/kubernetes/test/e2e/pohsien"</span>
<span class="p">)</span>
<span class="o">...</span>
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>
    <p>接下來撰寫及修改 BUILD 檔來讓 <code class="language-plaintext highlighter-rouge">kubetest --build</code> 或是 <code class="language-plaintext highlighter-rouge">make</code> 時能抓到我們寫的測試檔。主要有兩個地方: 一個是在 <code class="language-plaintext highlighter-rouge">kubernetes/test/e2e/pohsien/</code> 底下新增 BUILD 檔，另一個是在 <code class="language-plaintext highlighter-rouge">kubernetes/test/e2e/BUILD</code> 裡加上我們寫的測試檔。</p>

    <blockquote class="prompt-info"><div>
      <p>BUILD 檔寫法可以參考其他 E2E 測項。</p>
    </div></blockquote>

    <div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>vim kubernetes/test/e2e/pohsien/BUILD
<span class="nv">$ </span>vim kubernetes/test/e2e/BUILD
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
  <li>
    <p>完成後，接下來我們就可以執行看看。</p>

    <div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>kubetest <span class="nt">--build</span>
<span class="nv">$ </span>kubetest <span class="nt">--test</span> <span class="nt">--test_args</span><span class="o">=</span><span class="s2">"--ginkgo.focus=</span><span class="se">\[</span><span class="s2">Pohsien</span><span class="se">\]</span><span class="s2">"</span>


<span class="o">[</span>pohsien-testing] Kubernetes Pohsien<span class="s1">'s Pod [Pohsien]
Make sure the pohsien pod can be deployed
/root/go/src/k8s.io/kubernetes/_output/local/go/src/k8s.io/kubernetes/test/e2e/pohsien/pohsien.go:35
...
STEP: Create Pod
STEP: Get the pod
[AfterEach] [pohsien-testing] Kubernetes Pohsien'</span>s Pod <span class="o">[</span>Pohsien]
/root/go/src/k8s.io/kubernetes/_output/local/go/src/k8s.io/kubernetes/test/e2e/framework/framework.go:151
Oct 25 09:33:54.652: INFO: Waiting up to 3m0s <span class="k">for </span>all <span class="o">(</span>but 0<span class="o">)</span> nodes to be ready
STEP: Destroying namespace <span class="s2">"pods-1457"</span> <span class="k">for </span>this suite.
Oct 25 09:34:16.682: INFO: Waiting up to 30s <span class="k">for </span>server preferred namespaced resources to be successfully discovered
Oct 25 09:34:16.740: INFO: namespace pods-1457 deletion completed <span class="k">in </span>22.085125288s
Oct 25 09:34:16.742: INFO: Running AfterSuite actions on all nodes
Oct 25 09:34:16.742: INFO: Running AfterSuite actions on node 1

Ran 1 of 4414 Specs <span class="k">in </span>28.369 seconds
SUCCESS! <span class="nt">--</span> 1 Passed | 0 Failed | 0 Pending | 4413 Skipped
PASS

Ginkgo ran 1 suite <span class="k">in </span>29.513161526s
Test Suite Passed
2019/10/25 09:34:16 process.go:155: Step <span class="s1">'./hack/ginkgo-e2e.sh --ginkgo.focus=\[Pohsien\]'</span> finished <span class="k">in </span>29.787466628s
</pre></td></tr></tbody></table></code></div>    </div>
  </li>
</ol>

<p>到這裡 Kubernetes E2E Testing 解釋就告一段落，下一篇文章會介紹如何在自己建立的 Cluster 做 E2E Test 。</p>

<h1 id="references">References</h1>
<ol>
  <li><a href="https://www.softwaretestinghelp.com/types-of-software-testing/">Types Of Software Testing: Different Testing Types With Details</a></li>
  <li><a href="https://en.wikipedia.org/wiki/Special_Interest_Group">WIKIPEDIA - Special Interest Group</a></li>
  <li><a href="https://github.com/kubernetes/community/blob/master/sig-list.md">Kubernetes SIGs and Working Groups</a></li>
  <li><a href="https://github.com/kubernetes/community/blob/master/governance.md">Kubernetes Community Governance Model</a></li>
  <li><a href="https://github.com/kubernetes/community/blob/master/sigs.yaml">Subprojects of each SIGs</a></li>
  <li><a href="https://github.com/kubernetes/community/tree/master/sig-testing#testing-special-interest-group">Sig-Testing</a></li>
  <li><a href="https://github.com/kubernetes/test-infra">test-infra</a></li>
  <li><a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-testing/e2e-tests.md">Kubernetes E2E Testing</a></li>
  <li><a href="https://github.com/kubernetes/test-infra/tree/master/kubetest">Kubetest</a></li>
  <li><a href="https://onsi.github.io/ginkgo/">Ginkgo</a></li>
  <li><a href="http://onsi.github.io/gomega/">Gomega</a></li>
  <li><a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-testing/e2e-tests.md">End-To-End Testing in Kubernetes</a></li>
  <li><a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-testing/writing-good-e2e-tests.md">Writing good e2e tests for Kubernetes</a></li>
</ol>

<blockquote class="prompt-info"><div>
  <p>文章內容的轉載、重製、發佈，請註明出處: <a href="https://pohsienshih.github.io">https://pohsienshih.github.io</a></p>
</div></blockquote>

</div>

<div class="post-tail-wrapper text-muted">

  <!-- categories -->
  
  <div class="post-meta mb-3">
    <i class="far fa-folder-open fa-fw mr-1"></i>
    
      <a href='/categories/kubernetes/'>Kubernetes</a>
  </div>
  

  <!-- tags -->
  
  <div class="post-tags">
    <i class="fa fa-tags fa-fw mr-1"></i>
      
      <a href="/tags/kubernetes/"
          class="post-tag no-text-decoration" >kubernetes</a>
      
      <a href="/tags/testing/"
          class="post-tag no-text-decoration" >testing</a>
      
  </div>
  

  <div class="post-tail-bottom
    d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
    <div class="license-wrapper">

      

        

        This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.

      
    </div>

    <!--
 Post sharing snippet
-->

<div class="share-wrapper">
  <span class="share-label text-muted mr-1">Share</span>
  <span class="share-icons">
    
    

    
      
        <a href="https://twitter.com/intent/tweet?text=End-to-End Testing for Kubernetes (Part I) - kubetest - Po-Hsien Workspace&amp;url=https://blog.phshih.com/blog/e2e-testing-for-kubernetes-part-i/" data-toggle="tooltip" data-placement="top"
          title="Twitter" target="_blank" rel="noopener" aria-label="Twitter">
          <i class="fa-fw fab fa-twitter"></i>
        </a>
    
      
        <a href="https://www.facebook.com/sharer/sharer.php?title=End-to-End Testing for Kubernetes (Part I) - kubetest - Po-Hsien Workspace&amp;u=https://blog.phshih.com/blog/e2e-testing-for-kubernetes-part-i/" data-toggle="tooltip" data-placement="top"
          title="Facebook" target="_blank" rel="noopener" aria-label="Facebook">
          <i class="fa-fw fab fa-facebook-square"></i>
        </a>
    
      
        <a href="https://t.me/share/url?url=https://blog.phshih.com/blog/e2e-testing-for-kubernetes-part-i/&amp;text=End-to-End Testing for Kubernetes (Part I) - kubetest - Po-Hsien Workspace" data-toggle="tooltip" data-placement="top"
          title="Telegram" target="_blank" rel="noopener" aria-label="Telegram">
          <i class="fa-fw fab fa-telegram"></i>
        </a>
    

    <i id="copy-link" class="fa-fw fas fa-link small"
        data-toggle="tooltip" data-placement="top"
        title="Copy link"
        data-title-succeed="Link copied successfully!">
    </i>

  </span>
</div>


  </div><!-- .post-tail-bottom -->

</div><!-- div.post-tail-wrapper -->


      
    
    

    </div>
  </div> <!-- #core-wrapper -->

  <!-- pannel -->
  <div id="panel-wrapper" class="col-xl-3 pl-2 text-muted">

    <div class="access">
      















  <div id="access-lastmod" class="post">
    <div class="panel-heading">Recently Updated</div>
    <ul class="post-content pl-0 pb-1 ml-1 mt-2">
      
        
        
        
      <li><a href="/blog/mariadb-master-slave-replication-with-maxscale/">MariaDB Master-Slave Replication with MaxScale</a></li>
      
    </ul>
  </div> <!-- #access-lastmod -->



      















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        



  <div id="access-tags">
    <div class="panel-heading">Trending Tags</div>
    <div class="d-flex flex-wrap mt-3 mb-1 mr-3">

    
      
      <a class="post-tag" href="/tags/kubernetes/">kubernetes</a>
    
      
      <a class="post-tag" href="/tags/personal/">Personal</a>
    
      
      <a class="post-tag" href="/tags/conference/">conference</a>
    
      
      <a class="post-tag" href="/tags/high-availability/">high availability</a>
    
      
      <a class="post-tag" href="/tags/pks/">pks</a>
    
      
      <a class="post-tag" href="/tags/testing/">testing</a>
    
      
      <a class="post-tag" href="/tags/activemq/">activemq</a>
    
      
      <a class="post-tag" href="/tags/elk/">ELK</a>
    
      
      <a class="post-tag" href="/tags/log/">log</a>
    
      
      <a class="post-tag" href="/tags/mariadb/">mariadb</a>
    

    </div>
  </div>


    </div>

    
      
      



<!-- BS-toc.js will be loaded at medium priority -->
<script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script>

<div id="toc-wrapper" class="pl-0 pr-4 mb-5">
  <div class="panel-heading pl-3 pt-2 mb-2">Contents</div>
  <nav id="toc" data-toggle="toc"></nav>
</div>


    
  </div>

</div>

<!-- tail -->

<div class="row">
  <div class="col-12 col-lg-11 col-xl-8">
    <div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">
      
        
        <!--
 Recommend the other 3 posts according to the tags and categories of the current post,
 if the number is not enough, use the other latest posts to supplement.
-->

<!-- The total size of related posts  -->


<!-- An random integer that bigger than 0  -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy}  -->








  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  
    
  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  








<!-- Fill with the other newlest posts  -->






  <div id="related-posts" class="mt-5 mb-2 mb-sm-4">
    <h3 class="pt-2 mt-1 mb-4 ml-1"
      data-toc-skip>Further Reading</h3>
    <div class="card-deck mb-4">
    
      
      
      <div class="card">
        <a href="/blog/e2e-testing-for-kubernetes-part-ii/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/timeago.js
-->

<em class="timeago small"
    data-ts="1572121034"
    
    >
  2019-10-26
</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>End-to-End Testing for Kubernetes (Part II) - Conformance Testing</h3>
            <div class="text-muted small">
              <p>
                





                此系列文為 E2E Testing for Kubernetes 的介紹，如尚未看過前一篇文章，可以參考底下連結:

  End-to-End Testing for Kubernetes (Part I) - kubetest
  End-to-End Testing for Kubernetes (Part II) - Conformance Testing


Conformance ...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/blog/enterprise-pks-k8s-node-disk-out-of-space/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/timeago.js
-->

<em class="timeago small"
    data-ts="1562102544"
    
    >
  2019-07-02
</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>針對Enterprise PKS環境的K8s Cluster Node硬碟空間不足測試及解法</h3>
            <div class="text-muted small">
              <p>
                





                
  此篇文章已不再更新，內容可能已過時


這篇主要是測試Enterprise PKS佈出來的Kubernetes Node 上面的硬碟滿了會造成什麼影響以及要如何解決。其實這個問題應該跟一般Kubernetes環境差不多，只是目前有一些case緣故還是需要在Enterprise PKS環境下測試一下。因此特別針對這部分做測試。


Kubernetes Node上的disk種類
在PCF...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/blog/enterprise-pks-introduction/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/timeago.js
-->

<em class="timeago small"
    data-ts="1561680417"
    
    >
  2019-06-28
</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>Enterprise PKS介紹</h3>
            <div class="text-muted small">
              <p>
                





                
  此篇文章已不再更新，內容可能已過時


PKS全名是Pivotal Container Service，顧名思義是由Pivotal這間公司開發的。Pivotal是VMware的子公司，也許比較少人知道這間公司，不過相信大家應該都聽過tomcat或是redis，這兩個知名的專案就是由Pivotal開發的，由此可知Pivotal也是一家技術非常扎實強大的公司。

PKS介紹
PKS是用來管...
              </p>
            </div>
          </div>
        </a>
      </div>
    
    </div> <!-- .card-deck -->
  </div> <!-- #related-posts -->


      
        
        <!--
  Navigation buttons at the bottom of the post.
-->

<div class="post-navigation d-flex justify-content-between">
  
  <a href="/blog/elk-filebeat-with-log-rotate/" class="btn btn-outline-primary"
    prompt="Older">
    <p>ELK Filebeat With Log Rotate</p>
  </a>
  

  
  <a href="/blog/e2e-testing-for-kubernetes-part-ii/" class="btn btn-outline-primary"
    prompt="Newer">
    <p>End-to-End Testing for Kubernetes (Part II) - Conformance Testing</p>
  </a>
  

</div>

      
        
        <!--  The comments switcher -->


      
    </div>
  </div>
</div> <!-- .row -->



        <!--
  The Footer
-->

<footer class="d-flex w-100 justify-content-center">
  <div class="d-flex justify-content-between align-items-center text-muted">
    <div class="footer-left">
      <p class="mb-0">
        © 2022
        <a href="https://github.com/username">Po-Hsien Shih</a>.
        
        <span data-toggle="tooltip" data-placement="top"
          title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span>
        
      </p>
    </div>

    <div class="footer-right">
      <p class="mb-0">
        

        

        Powered by 
          <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>
         with 
          <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a>
         theme.

      </p>
    </div>

  </div> <!-- div.d-flex -->
</footer>


      </div>

      <!--
  The Search results
-->
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-12 col-sm-11 post-content">
    <div id="search-hints">
      















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        



  <div id="access-tags">
    <div class="panel-heading">Trending Tags</div>
    <div class="d-flex flex-wrap mt-3 mb-1 mr-3">

    
      
      <a class="post-tag" href="/tags/kubernetes/">kubernetes</a>
    
      
      <a class="post-tag" href="/tags/personal/">Personal</a>
    
      
      <a class="post-tag" href="/tags/conference/">conference</a>
    
      
      <a class="post-tag" href="/tags/high-availability/">high availability</a>
    
      
      <a class="post-tag" href="/tags/pks/">pks</a>
    
      
      <a class="post-tag" href="/tags/testing/">testing</a>
    
      
      <a class="post-tag" href="/tags/activemq/">activemq</a>
    
      
      <a class="post-tag" href="/tags/elk/">ELK</a>
    
      
      <a class="post-tag" href="/tags/log/">log</a>
    
      
      <a class="post-tag" href="/tags/mariadb/">mariadb</a>
    

    </div>
  </div>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>


    </div> <!-- #main-wrapper -->

    

    <div id="mask"></div>

    <a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button">
      <i class="fas fa-angle-up"></i>
    </a>

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script>

<script>
SimpleJekyllSearch({
  searchInput: document.getElementById('search-input'),
  resultsContainer: document.getElementById('search-results'),
  json: '/assets/js/data/search.json',
  searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0">  <a href="{url}">{title}</a>  <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">    {categories}    {tags}  </div>  <p>{snippet}</p></div>',
  noResultsText: '<p class="mt-5">Oops! No result founds.</p>',
  templateMiddleware: function(prop, value, template) {
    if (prop === 'categories') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
      }
    }

    if (prop === 'tags') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
      }
    }
  }
});
</script>


    <!--
  JS selector for site.
-->

<!-- layout specified -->


  



  <!-- image lazy-loading & popup & clipboard -->
  

  







  
    

    

  



  
    

    

  



  
    

    

  




  <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script>







  

  

  







  
    

    

  



  
    

    

  



  
    

    

  



  
    

    

  




  <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script>








<script defer src="/assets/js/dist/post.min.js"></script>



<!-- commons -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script>




  </body>

</html>

