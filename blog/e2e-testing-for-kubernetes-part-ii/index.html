<!DOCTYPE html>













<html lang="en"
  
>

  <!--
  The Head
-->

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  
  <meta name="keywords" content="e2e, testing, kubernetes, kubetest, conformance, sonobuoy">
  
  <!-- Allow having a localized datetime different from the appearance language -->
  

  

    

    

  

  

  

  
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="End-to-End Testing for Kubernetes (Part II) - Conformance Testing" />
<meta property="og:locale" content="en" />
<meta name="description" content="e2e, testing, kubernetes, kubetest, conformance, sonobuoy" />
<meta property="og:description" content="e2e, testing, kubernetes, kubetest, conformance, sonobuoy" />
<link rel="canonical" href="http://0.0.0.0:4000/blog/e2e-testing-for-kubernetes-part-ii/" />
<meta property="og:url" content="http://0.0.0.0:4000/blog/e2e-testing-for-kubernetes-part-ii/" />
<meta property="og:site_name" content="Po-Hsien Workspace" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-10-26T20:17:14+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="End-to-End Testing for Kubernetes (Part II) - Conformance Testing" />
<meta name="twitter:site" content="@twitter_username" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2019-10-26T20:17:14+00:00","datePublished":"2019-10-26T20:17:14+00:00","description":"e2e, testing, kubernetes, kubetest, conformance, sonobuoy","headline":"End-to-End Testing for Kubernetes (Part II) - Conformance Testing","mainEntityOfPage":{"@type":"WebPage","@id":"http://0.0.0.0:4000/blog/e2e-testing-for-kubernetes-part-ii/"},"url":"http://0.0.0.0:4000/blog/e2e-testing-for-kubernetes-part-ii/"}</script>
<!-- End Jekyll SEO tag -->

  

  <title>End-to-End Testing for Kubernetes (Part II) - Conformance Testing | Po-Hsien Workspace
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Po-Hsien Workspace">
<meta name="application-name" content="Po-Hsien Workspace">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  

    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin>
    
      <link rel="preconnect" href="https://fonts.googleapis.com" >
      <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
    
      <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
    

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">

  

  <!-- GA -->
  

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css">

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css">

  <link rel="stylesheet" href="/assets/css/style.css">

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css">
  

  
    <!-- Manific Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css">
  

  <!-- JavaScript -->

  <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>

  
    <!--
  Switch the mode between dark and light.
-->

<script type="text/javascript">
  class ModeToggle {
    static get MODE_KEY() { return "mode"; }
    static get MODE_ATTR() { return "data-mode"; }
    static get DARK_MODE() { return "dark"; }
    static get LIGHT_MODE() { return "light"; }
    static get ID() { return "mode-toggle"; }

    constructor() {
      if (this.hasMode) {
        if (this.isDarkMode) {
          if (!this.isSysDarkPrefer) {
            this.setDark();
          }
        } else {
          if (this.isSysDarkPrefer) {
            this.setLight();
          }
        }
      }

      let self = this;

      /* always follow the system prefers */
      this.sysDarkPrefers.addEventListener("change", () => {
        if (self.hasMode) {
          if (self.isDarkMode) {
            if (!self.isSysDarkPrefer) {
              self.setDark();
            }

          } else {
            if (self.isSysDarkPrefer) {
              self.setLight();
            }
          }

          self.clearMode();
        }

        self.notify();

      });

    } /* constructor() */

    get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); }

    get isSysDarkPrefer() { return this.sysDarkPrefers.matches; }

    get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; }

    get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; }

    get hasMode() { return this.mode != null; }

    get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); }

    /* get the current mode on screen */
    get modeStatus() {
      if (this.isDarkMode
        || (!this.hasMode && this.isSysDarkPrefer)) {
        return ModeToggle.DARK_MODE;
      } else {
        return ModeToggle.LIGHT_MODE;
      }
    }

    setDark() {
      $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE);
    }

    setLight() {
      $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE);
    }

    clearMode() {
      $('html').removeAttr(ModeToggle.MODE_ATTR);
      sessionStorage.removeItem(ModeToggle.MODE_KEY);
    }

    /* Notify another plugins that the theme mode has changed */
    notify() {
      window.postMessage({
        direction: ModeToggle.ID,
        message: this.modeStatus
      }, "*");
    }

  } /* ModeToggle */

  const toggle = new ModeToggle();

  function flipMode() {
    if (toggle.hasMode) {
      if (toggle.isSysDarkPrefer) {
        if (toggle.isLightMode) {
          toggle.clearMode();
        } else {
          toggle.setLight();
        }

      } else {
        if (toggle.isDarkMode) {
          toggle.clearMode();
        } else {
          toggle.setDark();
        }
      }

    } else {
      if (toggle.isSysDarkPrefer) {
        toggle.setLight();
      } else {
        toggle.setDark();
      }
    }

    toggle.notify();

  } /* flipMode() */

</script>

  
</head>


  
    <!--
  Switch the mode between dark and light.
-->

<script type="text/javascript">
  class ModeToggle {
    static get MODE_KEY() { return "mode"; }
    static get MODE_ATTR() { return "data-mode"; }
    static get DARK_MODE() { return "dark"; }
    static get LIGHT_MODE() { return "light"; }
    static get ID() { return "mode-toggle"; }

    constructor() {
      if (this.hasMode) {
        if (this.isDarkMode) {
          if (!this.isSysDarkPrefer) {
            this.setDark();
          }
        } else {
          if (this.isSysDarkPrefer) {
            this.setLight();
          }
        }
      }

      let self = this;

      /* always follow the system prefers */
      this.sysDarkPrefers.addEventListener("change", () => {
        if (self.hasMode) {
          if (self.isDarkMode) {
            if (!self.isSysDarkPrefer) {
              self.setDark();
            }

          } else {
            if (self.isSysDarkPrefer) {
              self.setLight();
            }
          }

          self.clearMode();
        }

        self.notify();

      });

    } /* constructor() */

    get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); }

    get isSysDarkPrefer() { return this.sysDarkPrefers.matches; }

    get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; }

    get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; }

    get hasMode() { return this.mode != null; }

    get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); }

    /* get the current mode on screen */
    get modeStatus() {
      if (this.isDarkMode
        || (!this.hasMode && this.isSysDarkPrefer)) {
        return ModeToggle.DARK_MODE;
      } else {
        return ModeToggle.LIGHT_MODE;
      }
    }

    setDark() {
      $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE);
    }

    setLight() {
      $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE);
    }

    clearMode() {
      $('html').removeAttr(ModeToggle.MODE_ATTR);
      sessionStorage.removeItem(ModeToggle.MODE_KEY);
    }

    /* Notify another plugins that the theme mode has changed */
    notify() {
      window.postMessage({
        direction: ModeToggle.ID,
        message: this.modeStatus
      }, "*");
    }

  } /* ModeToggle */

  const toggle = new ModeToggle();

  function flipMode() {
    if (toggle.hasMode) {
      if (toggle.isSysDarkPrefer) {
        if (toggle.isLightMode) {
          toggle.clearMode();
        } else {
          toggle.setLight();
        }

      } else {
        if (toggle.isDarkMode) {
          toggle.clearMode();
        } else {
          toggle.setDark();
        }
      }

    } else {
      if (toggle.isSysDarkPrefer) {
        toggle.setLight();
      } else {
        toggle.setDark();
      }
    }

    toggle.notify();

  } /* flipMode() */

</script>

  

  <body data-spy="scroll" data-target="#toc" data-topbar-visible="true">

    <!--
  The Side Bar
-->

<div id="sidebar" class="d-flex flex-column align-items-end">
  <div class="profile-wrapper text-center">
    <div id="avatar">
      <a href="/" alt="avatar" class="mx-auto">
        
          
          <img src="
            
              /assets/images/pohsien.jpg
            
          " alt="avatar" onerror="this.style.display='none'">
        
      </a>
    </div>

    <div class="site-title mt-3">
      <a href="/">Po-Hsien Workspace</a>
    </div>
    <div class="site-subtitle font-italic">Cloud Native, Containerization, Virtualization, Linux Technologies.</div>

  </div><!-- .profile-wrapper -->

  <ul class="w-100">

    <!-- home -->
    <li class="nav-item">
      <a href="/" class="nav-link">
        <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i>
        <span>HOME</span>
      </a>
    </li>
    <!-- the real tabs -->
    
    <li class="nav-item">
      <a href="/categories/" class="nav-link">
        <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>CATEGORIES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/tags/" class="nav-link">
        <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>TAGS</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/archives/" class="nav-link">
        <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>ARCHIVES</span>
      </a>
    </li> <!-- .nav-item -->
    
    <li class="nav-item">
      <a href="/about/" class="nav-link">
        <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i>
        

        <span>ABOUT</span>
      </a>
    </li> <!-- .nav-item -->
    

  </ul> <!-- ul.nav.flex-column -->

  <div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center">

    
      <button class="mode-toggle btn" aria-label="Switch Mode">
        <i class="fas fa-adjust"></i>
      </button>

      
        <span class="icon-border"></span>
      
    

    
      

      
      <a href="https://github.com/pohsien324" aria-label="github"
        target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
      

    
      

      
      <a href="
          javascript:location.href = 'mailto:' + ['pohsien324','gmail.com'].join('@')" aria-label="email"
        >
        <i class="fas fa-envelope"></i>
      </a>
      

    
      

      
      <a href="https://www.linkedin.com/in/po-hsien-shih-23bbb1162/" aria-label="linkedin"
        target="_blank" rel="noopener">
        <i class="fab fa-linkedin"></i>
      </a>
      

    
      

      
      <a href="/feed.xml" aria-label="rss"
        >
        <i class="fas fa-rss"></i>
      </a>
      

    

  </div> <!-- .sidebar-bottom -->

</div><!-- #sidebar -->


    <!--
  The Top Bar
-->

<div id="topbar-wrapper" class="row justify-content-center">
  <div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between">
    <span id="breadcrumb">

    

    

      

        
          <span>
            <a href="/">
              Home
            </a>
          </span>

        

      

        

      

        

          
            <span>End-to-End Testing for Kubernetes (Part II) - Conformance Testing</span>
          

        

      

    

    </span><!-- endof #breadcrumb -->

    <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i>

    <div id="topbar-title">
      Post
    </div>

    <i id="search-trigger" class="fas fa-search fa-fw"></i>
    <span id="search-wrapper" class="align-items-center">
      <i class="fas fa-search fa-fw"></i>
      <input class="form-control" id="search-input" type="search"
        aria-label="search" autocomplete="off" placeholder="Search...">
    </span>
    <span id="search-cancel" >Cancel</span>
  </div>

</div>


    <div id="main-wrapper">
      <div id="main">

        









<div class="row">

  <!-- core -->
  <div id="core-wrapper" class="col-12 col-lg-11 col-xl-8">
    <div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">

    

    
      
      
        <!--
  Refactor the HTML structure.
-->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Add attribute 'hide-bullet' to the checkbox list -->



<!-- images -->




  
  

  
    
      
      
    

    
    
    

    
    

    
    
    

    
      
      

      
      

      

      
    
      
      

      
      

      

      
    

    
      

        <!-- Add CDN URL -->
        

        <!-- Add image path -->
        

        
        

      

      <!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> -->

      

    

    <!-- Add SVG placehoder to prevent layout reflow -->

    

    <!-- Bypass the HTML-proofer test -->
    

    

  
    

    
    
    

    
    

    
    
    

    
      
      

      
      

      

      
    
      
      

      
      

      

      
    

    
      

        <!-- Add CDN URL -->
        

        <!-- Add image path -->
        

        
        

      

      <!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> -->

      

    

    <!-- Add SVG placehoder to prevent layout reflow -->

    

    <!-- Bypass the HTML-proofer test -->
    

    

  
    

    
    
    

    
    

    
    
    

    
      
      

      
      

      

      
    
      
      

      
      

      

      
    

    
      

        <!-- Add CDN URL -->
        

        <!-- Add image path -->
        

        
        

      

      <!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> -->

      

    

    <!-- Add SVG placehoder to prevent layout reflow -->

    

    <!-- Bypass the HTML-proofer test -->
    

    

  
    

    
    
    

    
    

    
    
    

    
      
      

      
      

      

      
    
      
      

      
      

      

      
    

    
      

        <!-- Add CDN URL -->
        

        <!-- Add image path -->
        

        
        

      

      <!-- lazy-load images <https://github.com/ApoorvSaxena/lozad.js#usage> -->

      

    

    <!-- Add SVG placehoder to prevent layout reflow -->

    

    <!-- Bypass the HTML-proofer test -->
    

    

  

  



<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    

    

  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    
      

      
      

      
      
      

      

    

    

  

  
  

  

  
  

  




<!-- Wrap prompt element of blockquote with the <div> tag -->







  
  

  

    
      
      

    

    
    

    
    
    

    
      
        
        

    

    
    

    

  

    

    
    

    
    
    

    
      
        
        

    

    
    

    

  

  



<!-- return -->







<h1 data-toc-skip>End-to-End Testing for Kubernetes (Part II) - Conformance Testing</h1>

<div class="post-meta text-muted">

  <!-- author -->
  <div>
    
    

    

    By
    <em>
      
        <a href="https://github.com/username">Po-Hsien Shih</a>
      
    </em>
  </div>

  <div class="d-flex">
    <div>
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/timeago.js
-->

<em class="timeago"
    data-ts="1572121034"
    
      data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll"
    
    >
  2019-10-26
</em>

      </span>

      <!-- lastmod date -->
      

      <!-- read time -->
      <!--
  Calculate the post's reading time, and display the word count in tooltip
 -->



<!-- words per minute  -->










<!-- return element -->
<span class="readtime" data-toggle="tooltip" data-placement="bottom"
  title="3395 words">
  <em>18 min</em> read</span>


      <!-- page views -->
      
    </div>

  </div> <!-- .d-flex -->

</div> <!-- .post-meta -->

<div class="post-content">
  <p>此系列文為 E2E Testing for Kubernetes 的介紹，如尚未看過前一篇文章，可以參考底下連結:</p>
<ul>
  <li><a href="/blog/e2e-testing-for-kubernetes-part-i/">End-to-End Testing for Kubernetes (Part I) - kubetest</a></li>
  <li><a href="/blog/e2e-testing-for-kubernetes-part-ii/">End-to-End Testing for Kubernetes (Part II) - Conformance Testing</a></li>
</ul>

<h1 id="conformance-testing">Conformance Testing</h1>
<p>在前一篇文章裡，我們介紹到如何使用 kubetest 執行 Kubernetes E2E Test ， kubetest 會使用 Kubernetes Binary 開啟新的乾淨 Cluster 去做測試。在這一篇文章裡我們會介紹如何對自己部署的 Cluster 做 E2E Test。
<!--more--></p>

<p>Conformance Testing ，一致性測試，這個測試是 E2E Testing 底下的一個子集合，其主要是驗證 Kubernetes 核心的功能或是 GA 版本的 API ，也就是不管任何版本的 Cluster 都應該要能使用的基本功能。這個測試也可以解讀成: 「不管任何版本或平台的 Cluster 在經過 Conformance Test 之後的結果都要是一致的」。由於 Conformance Test 比較不限定於 Cluster 版本或是平台，因此可以用來測試自己部署的 Cluster 是否是正常的。另外 Conformance Test 也是非破壞性的測試，不會包含 <code class="language-plaintext highlighter-rouge">[Disruptive]</code> 的測項，因此並不會影響到 Cluster 上面運行的其他服務。</p>

<blockquote class="prompt-info"><div>
  <p>在前一篇文章有提到 <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-testing/e2e-tests.md#kinds-of-tests">Kind of Test</a> ，其中一個 Label 是 <code class="language-plaintext highlighter-rouge">[Conformance]</code> ，這個就是代表 Conformance Test 的測項。</p>
</div></blockquote>

<h2 id="conformance-test-requirements"><span class="mr-2">Conformance Test Requirements</span><a href="#conformance-test-requirements" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2>
<p>Kubernetes 有列出 Conformance Test 需要滿足的條件，有非常多項，其中包含只測試 GA 版本的 API 、必須可以使用在任何 Provider 上、不需要連接到 Public Network 、不需要 Privileged 權限或是不能包含具有關於 Node 或是平台相依性的測試，如硬體規格限制等等。不過這份文件也有提到如果將來有足夠的測項能測試 Cluster 之後，會慢慢的放寬這些條件，加入更多的測項進來。</p>

<ul>
  <li>it tests only GA, non-optional features or APIs (e.g., no alpha or beta endpoints, no feature flags required, no deprecated features)</li>
  <li>it does not require direct access to kubelet’s API to pass (nor does it require indirect access via the API server node proxy endpoint); it MAY use the kubelet API for debugging purposes upon failure</li>
  <li>it works for all providers (e.g., no SkipIfProviderIs/SkipUnlessProviderIs calls)</li>
  <li>it is non-privileged (e.g., does not require root on nodes, access to raw network interfaces, or Cluster admin permissions)</li>
  <li>it works without access to the public internet (short of whatever is required to pre-pull images for conformance tests)
…</li>
</ul>

<p>如果想了解更細部的需求條件可以參考 <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/conformance-tests.md#conformance-test-requirements">Conformance Test Requirements</a>。</p>

<h2 id="exexcution"><span class="mr-2">Exexcution</span><a href="#exexcution" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2>
<p>我們同樣可以使用 kubetest 來執行 Conformance Test ，執行步驟非常簡單，只需要限定只執行 <code class="language-plaintext highlighter-rouge">[Conformance]</code> Label 的測項即可。</p>

<ol>
  <li>前置作業</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="c"># Checking your kubernetes server version</span>
<span class="nv">$ </span>kubectl get version

Server Version: version.Info<span class="o">{</span>Major:<span class="s2">"1"</span>, Minor:<span class="s2">"15"</span>, GitVersion:<span class="s2">"v1.15.3"</span>, GitCommit:<span class="s2">"2d3c76f9091b6bec110a5e63777c332469e0cba2"</span>, GitTreeState:<span class="s2">"clean"</span>, BuildDate:<span class="s2">"2019-08-19T11:05:50Z"</span>, GoVersion:<span class="s2">"go1.12.9"</span>, Compiler:<span class="s2">"gc"</span>, Platform:<span class="s2">"linux/amd64"</span><span class="o">}</span>

<span class="c"># Change Kubernetes repository to the specific version</span>
<span class="nv">$ </span><span class="nb">cd</span> <span class="nv">$GOPATH</span>/src/k8s.io/kubernetes
<span class="nv">$ </span>git checkout v1.15.3

<span class="c"># Build e2e.test, ginkgo and kubectl</span>
<span class="c"># 這邊也可以直接使用　kubetest --build ，只是 Conformance Testing 不需要 </span>
<span class="c"># build 這麼多東西。</span>
<span class="nv">$ </span>make <span class="nv">WHAT</span><span class="o">=</span><span class="s2">"test/e2e/e2e.test vendor/github.com/onsi/ginkgo/ginkgo cmd/kubectl"</span>
</pre></td></tr></tbody></table></code></div></div>
<p>這邊需要注意的是: kubetest 會直接抓 Kubernetes 目錄 Build 出來的 kubectl 當作 Client 去做測試， 如果 kubectl 的版本 ( <code class="language-plaintext highlighter-rouge">GitVersion</code> ) 與 Server 版本不一致， kubetest 會報錯，因此最好先將 Kubernetes 切換到對應版本的 branch/tag ，再 build e2e.test 跟 kubectl 比較好。</p>

<p>如果真的想要用不同版本的 Client (kubectl) 做測試，可以在 kubetest 後面加上 <code class="language-plaintext highlighter-rouge">--check-version-skew=false</code> flag，但是不建議這樣做，因為可能會影響測試的準確度。</p>

<p>2.執行測試</p>

<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="c"># Setup for conformance tests</span>
<span class="nv">$ </span><span class="nb">export </span><span class="nv">KUBECONFIG</span><span class="o">=</span>/path/to/kubeconfig
<span class="nv">$ </span><span class="nb">export </span><span class="nv">KUBERNETES_CONFORMANCE_TEST</span><span class="o">=</span>y

<span class="c"># Run testing</span>
<span class="nv">$ </span>kubetest <span class="nt">--provider</span><span class="o">=</span>skeleton <span class="nt">--test</span> <span class="nt">--test_args</span><span class="o">=</span><span class="s2">"--ginkgo.focus=</span><span class="se">\[</span><span class="s2">Conformance</span><span class="se">\]</span><span class="s2">"</span>

<span class="c"># Run testing with different version of client</span>
<span class="nv">$ </span>kubetest <span class="nt">--provider</span><span class="o">=</span>skeleton <span class="nt">--test</span> <span class="nt">--test_args</span><span class="o">=</span><span class="s2">"--ginkgo.focus=</span><span class="se">\[</span><span class="s2">Conformance</span><span class="se">\]</span><span class="s2">"</span> <span class="nt">--check-version-skew</span><span class="o">=</span><span class="nb">false</span>
</pre></td></tr></tbody></table></code></div></div>

<p>當設定 <code class="language-plaintext highlighter-rouge">KUBERNETES_CONFORMANCE_TEST=y</code> 時， <code class="language-plaintext highlighter-rouge">kubernetes/hack/ginkgo-e2e.sh</code> 就會從 <code class="language-plaintext highlighter-rouge">KUBECONFIG</code> 來取得 Master 位置，因此不再需要使用 <code class="language-plaintext highlighter-rouge">--deployment</code> flag 去告訴 kubetest (Ginkgo) Cluster 資訊。</p>

<p><code class="language-plaintext highlighter-rouge">--provider=skeleton</code>: 這邊的 <code class="language-plaintext highlighter-rouge">skeleton</code> 筆者也不確定如何解釋，類似於只有骨架，表示你的 Cluster 只有提供 API 介面(直接提供<code class="language-plaintext highlighter-rouge">kubeconfig</code>就可以存取到 Cluster )，而看不到整個整體的 Cluster ，這邊如果讀者有更好的解釋的話，再麻煩幫我修正一下，謝謝。</p>
<blockquote>
  <p>筆者實際執行 Conformance Test 大概花了 3~4 小時左右，不過同樣可能跟筆者 Homelab 硬體資源有關，實際上應該不需要這多時間。</p>
</blockquote>

<p><img data-src="/assets/images/e2e_k8s/conformance-running.png" style="width:100%" data-proofer-ignore></p>

<h2 id="test-lists"><span class="mr-2">Test Lists</span><a href="#test-lists" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2>
<p>由於 Conformance Testing 是 E2E Testing 的子集合，因此其測項一樣位於 <code class="language-plaintext highlighter-rouge">kubernetes/test/e2e/</code> 裡，不過 Kubernetes 有特別將 Conformance Testing 的測試項目清單記錄在 <a href="https://github.com/kubernetes/kubernetes/blob/master/test/conformance/testdata/conformance.txt">conformance.txt</a> 底下，如果要細看每一個測項內容的話也可以參考 <a href="https://github.com/cncf/k8s-conformance/blob/master/docs/KubeConformance-1.9.md">Kubernetes Conformance Test Suite - v1.9</a>。</p>

<p><code class="language-plaintext highlighter-rouge">kubernetes/test/conformance/testdata/conformance.txt</code>
<img data-src="/assets/images/e2e_k8s/conformance-txt.png" style="width:100%" data-proofer-ignore></p>

<p>查看其中一個 spec ，會發現 Conformance Test 是使用 <code class="language-plaintext highlighter-rouge">framework.ConformanceIt()</code> ，而不是像 E2E Test 使用 <code class="language-plaintext highlighter-rouge">Ginkgo.It()</code> 。</p>

<p><code class="language-plaintext highlighter-rouge">kubernetes/test/e2e/common/pods.go</code></p>
<div class="language-go highlighter-rouge"><div class="code-header">
        <span data-label-text="Go"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre>   <span class="o">...</span>
   <span class="c">/*
      Release : v1.9
      Testname: Pods, assigned hostip
      Description: Create a Pod. Pod status MUST return successfully and contains a valid IP address.
   */</span>
   <span class="n">framework</span><span class="o">.</span><span class="n">ConformanceIt</span><span class="p">(</span><span class="s">"should get a host IP [NodeConformance]"</span><span class="p">,</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
      <span class="n">name</span> <span class="o">:=</span> <span class="s">"pod-hostip-"</span> <span class="o">+</span> <span class="kt">string</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">NewUUID</span><span class="p">())</span>
      <span class="n">testHostIP</span><span class="p">(</span><span class="n">podClient</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v1</span><span class="o">.</span><span class="n">Pod</span><span class="p">{</span>
         <span class="n">ObjectMeta</span><span class="o">:</span> <span class="n">metav1</span><span class="o">.</span><span class="n">ObjectMeta</span><span class="p">{</span>
            <span class="n">Name</span><span class="o">:</span> <span class="n">name</span><span class="p">,</span>
         <span class="p">},</span>
         <span class="n">Spec</span><span class="o">:</span> <span class="n">v1</span><span class="o">.</span><span class="n">PodSpec</span><span class="p">{</span>
            <span class="n">Containers</span><span class="o">:</span> <span class="p">[]</span><span class="n">v1</span><span class="o">.</span><span class="n">Container</span><span class="p">{</span>
               <span class="p">{</span>
                  <span class="n">Name</span><span class="o">:</span>  <span class="s">"test"</span><span class="p">,</span>
                  <span class="n">Image</span><span class="o">:</span> <span class="n">imageutils</span><span class="o">.</span><span class="n">GetPauseImageName</span><span class="p">(),</span>
               <span class="p">},</span>
            <span class="p">},</span>
         <span class="p">},</span>
      <span class="p">})</span>
   <span class="p">})</span>
   <span class="o">...</span>
</pre></td></tr></tbody></table></code></div></div>

<p>實際去看 <code class="language-plaintext highlighter-rouge">framework.ConformanceIt()</code>  內容 (位於 <code class="language-plaintext highlighter-rouge">kubernetes/test/e2e/framework/framework.go</code>) ，會發現 <code class="language-plaintext highlighter-rouge">ConformanceIt()</code> 的功能為貼 <code class="language-plaintext highlighter-rouge">[Conformance]</code> Label ，至於為什麼要特別額外用一個 function 來貼 Label ，這邊官方註解是方便靜態分析用，不過筆者認為這樣也可以方便之後針對 Conformance Test 作修改，例如對所有的 Conformance Test 加上額外的 Label 或是增加什麼內容，直接透過 <code class="language-plaintext highlighter-rouge">ConformanceIt()</code> 就可以統一修改了。</p>

<p><code class="language-plaintext highlighter-rouge">kubernetes/test/e2e/framework/framework.go</code></p>
<div class="language-go highlighter-rouge"><div class="code-header">
        <span data-label-text="Go"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>   <span class="o">...</span>
   <span class="c">// ConformanceIt is wrapper function for ginkgo It.  Adds "[Conformance]" tag and makes static analysis easier.</span>
   <span class="k">func</span> <span class="n">ConformanceIt</span><span class="p">(</span><span class="n">text</span> <span class="kt">string</span><span class="p">,</span> <span class="n">body</span> <span class="k">interface</span><span class="p">{},</span> <span class="n">timeout</span> <span class="o">...</span><span class="kt">float64</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">ginkgo</span><span class="o">.</span><span class="n">It</span><span class="p">(</span><span class="n">text</span><span class="o">+</span><span class="s">" [Conformance]"</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">timeout</span><span class="o">...</span><span class="p">)</span>
   <span class="p">}</span>
   <span class="o">...</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="write-your-own-test"><span class="mr-2">Write Your Own Test</span><a href="#write-your-own-test" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2>
<p>接下來介紹如何撰寫自己的測項 ，基本上都跟 E2E Test 差不多，不過不確定是不是因為一般使用者比較常使用到 Conformance Test ， 這部分文件比 E2E Test 完整許多。</p>

<p>我們將撰寫測試分成三個步驟：</p>
<ol>
  <li>撰寫測試。</li>
  <li>確保你的測試有符合 [Conformance Test Requirements](#Conformance-Test-Requirements）。</li>
  <li>發送 <code class="language-plaintext highlighter-rouge">PR</code> 。</li>
</ol>

<p>細部流程可參考 <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/conformance-tests.md#promoting-tests-to-conformance">Promoting Tests to Conformance</a> 。</p>

<p><strong>1. 撰寫測試</strong><br />
在撰寫 Conformance Test 時必須遵守兩個的格式，一個是一定要使用 <code class="language-plaintext highlighter-rouge">framework.ConformanceIt()</code> ，不要使用 <code class="language-plaintext highlighter-rouge">Ginkgo.It</code> 。 另一個是一定要撰寫 <code class="language-plaintext highlighter-rouge">metadata</code> ，格式如下：</p>

<div class="language-go highlighter-rouge"><div class="code-header">
        <span data-label-text="Go"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="c">/*
  Release : v1.15.3
  Testname: Kubelet: log output
  Description: By default the stdout and stderr from the process being
  executed in a pod MUST be sent to the pod's logs.
*/</span>
<span class="n">framework</span><span class="o">.</span><span class="n">ConformanceIt</span><span class="p">(</span><span class="s">"it should print the output to logs"</span><span class="p">,</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
  <span class="o">...</span>
<span class="p">})</span>
</pre></td></tr></tbody></table></code></div></div>

<p>測試放置位置以及 Import 位置都與我們之前撰寫的 E2E Test 相同，因此這邊只簡單列出流程，細節部分可以參考前一篇文章。</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>1. 在 kubernets/test/e2e 建立資料夾來放置你的測試檔。
2. 在 kubernets/test/e2e/e2e_test.go 以及 kubernets/test/e2e/BUILD import 你的測試。
3. 在 kubernets/test/e2e/&lt;yourfolder&gt;/ 下新增你的 BUILD 檔。
4. 更新 conformance.txt
5. 使用 kubetest --build 重新 build e2e.test
</pre></td></tr></tbody></table></code></div></div>

<p>比較需要注意是第四步必須執行以下指令來更新 <code class="language-plaintext highlighter-rouge">conformance.txt</code> :</p>
<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>go run <span class="nb">test</span>/conformance/walk.go <span class="nb">test</span>/e2e <span class="o">&gt;</span> <span class="nb">test</span>/conformance/testdata/conformance.txt
</pre></td></tr></tbody></table></code></div></div>

<blockquote>
  <p>請記得在撰寫自己的測試時一定要加上對應 Label ，如 <code class="language-plaintext highlighter-rouge">[Slow]</code> 、 <code class="language-plaintext highlighter-rouge">[Serial]</code> 、 <code class="language-plaintext highlighter-rouge">[Disruptive]</code> 等等，這樣可以讓測試人員更加了解你的測項的特性，如果不確定要加上哪些 Label 可以在 slack 或是 發佈 Issue / PR 時，標註 <code class="language-plaintext highlighter-rouge">#kinds-of-tests </code> 來詢問。</p>
</blockquote>

<p><strong>2. 確保你的測試有符合 <code class="language-plaintext highlighter-rouge">[Conformance Test Requirements]</code></strong><br />
這部分可以參考 <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/conformance-tests.md#conformance-test-requirements">Conformance Test Requirements</a>。</p>

<p><strong>3. 發送 PR</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>1. PR Title:  "Promote xxx e2e test to Conformance"
2. 撰寫測項的資訊以及 metadata，並加上 PR Label 以及標註負責的 SIG。 
    - /area conformance 
    - @kubernetes/sig-architecture-pr-reviews @kubernetes/sig-xxx-pr-reviews  
      @kubernetes/cncf-conformance-wg
    - Any necessary information (e.g.  例如解釋為什麼測項無法在 Windows 執行)
3. 將 PR 加到 SIG Architecture's Conformance Test Review board 的 To Triage 欄位。
4. 使用 /test pull-kubernetes-e2e-aks-engine-azure-windows 來測試項目能否正常跑在 Windows Node 上
</pre></td></tr></tbody></table></code></div></div>
<blockquote>
  <p><a href="https://github.com/orgs/kubernetes/projects/9">Conformance Test Review board</a></p>
</blockquote>

<h2 id="for-windows"><span class="mr-2">For Windows</span><a href="#for-windows" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2>
<p>Comforance Testing 並沒有強制要求測項一定要支援 Windows Node ，但是既然 Kubernetes 有支援 Windows ，那還是必須要能夠對 Windows Node 做 Conformance Test 。在現有的測項中，大部分的測項都是可以在 Windows Node 執行的，只有少部分貼上 <code class="language-plaintext highlighter-rouge">[LinuxOnly]</code> 的測項是不能跑在 Windows 上的。</p>

<p>在撰寫自己的測試時，如果不確定 Linux Node 和 Windows Node 在測試執行上的差異或是不確定你寫的測項是否可以運行在 Windows 的話，可以參考 <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/conformance-tests.md#windows--linux-considerations">Windows &amp; Linux Considerations</a> 。</p>

<p>如果撰寫的測試不支援 Windows ，一定要標註 <code class="language-plaintext highlighter-rouge">[LinuxOnly]</code> Label，且在送PR時寫清楚為何不能跑在 Windows Node 上，讓 Reviewer 知道。</p>

<h2 id="vmware-tanzu-heptio-sonobuoy"><span class="mr-2">VMware Tanzu (Heptio) Sonobuoy</span><a href="#vmware-tanzu-heptio-sonobuoy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2>
<p>另外一個常見的 Kubernetes Conformance Testing Tool 是由 VMware Tanzu (Heptio) 開發的 <code class="language-plaintext highlighter-rouge">Sonobuoy</code> 。 Sonobuoy 提供比 kubetest 更方便的介面來做 Conformance Test ，只需要簡單幾行指令就可以執行測試，測試項目也與 kubetest 使用的 ( <code class="language-plaintext highlighter-rouge">kubernetes/test/e2e/...</code> ) 是完全一樣的，差別在於 Sonobuoy 是預先將測項全部放到 Docker Image 裡面，因此不需要像 kubetest 需要特別 Build e2e.test，不過需要注意的是 Sonobuoy 只支援前三新的 Kubernetes 版本。</p>

<p><a href="https://github.com/vmware-tanzu/sonobuoy">Sonobuoy Website</a></p>

<h3 id="certified-kubernetes"><span class="mr-2">Certified Kubernetes</span><a href="#certified-kubernetes" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3>
<p>Sonobuoy 同時也是 CNCF 官方用來認證 Kubernetes Cluster 的 Conformance Testing Tool，企業可以使用 Sonobuoy 來驗證自己開發的 Kubernetes 部署工具佈出來的 Cluster ，如果通過測試可以將結果提交到 GitHub ，該部署工具就可以獲得 CNCF 的認證標章，並顯示在 <a href="https://www.cncf.io/certification/software-conformance/">CNCF 官網</a>上，詳細驗證流程可以參考 <a href="https://github.com/cncf/k8s-conformance#certified-kubernetes">Certified Kubernetes</a> 。</p>

<p><img data-src="/assets/images/e2e_k8s/certified-tool.png" style="width:100%" data-proofer-ignore></p>

<h3 id="execution"><span class="mr-2">Execution</span><a href="#execution" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3>
<p>Sonobuoy 執行方式也很簡單，只需要設定 <code class="language-plaintext highlighter-rouge">KUBECONFIG</code> 然後執行 <code class="language-plaintext highlighter-rouge">sonobuoy run</code> 就可以跑 Conformance Test 了。</p>
<div class="language-bash highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">export </span><span class="nv">KUBECONFIG</span><span class="o">=</span>/path/to/kubeconfig
<span class="nv">$ </span>go get <span class="nt">-u</span> <span class="nt">-v</span> github.com/heptio/sonobuoy

<span class="c"># Start testing and wait until they are finished run:</span>
<span class="nv">$ </span>sonobuoy run <span class="nt">--wait</span>

<span class="c"># Get the result</span>
<span class="nv">$ results</span><span class="o">=</span><span class="si">$(</span>sonobuoy retrieve<span class="si">)</span>
<span class="nv">$ </span>sonobuoy e2e <span class="nv">$results</span>

<span class="c"># Delete the objects deployed by sonobuoy</span>
<span class="nv">$ </span>sonobuoy delete
</pre></td></tr></tbody></table></code></div></div>

<h3 id="result"><span class="mr-2">Result</span><a href="#result" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3>
<p>Sonobuoy 執行結果報告大致架構如下( <a href="https://sonobuoy.io/docs/v0.16.2/snapshot/">Sonobuoy Snapshot Layout</a> )：</p>

<p><code class="language-plaintext highlighter-rouge">servergroups.json</code>: 紀錄 Kubernetes API 資訊
<code class="language-plaintext highlighter-rouge">serverversion.json</code>: 紀錄 Kubernetes Cluster 版本資訊</p>

<p><strong>hosts</strong><br />
放置每個 Node 的 Configuration ( <code class="language-plaintext highlighter-rouge">configz.json</code> )跟健康狀態 ( <code class="language-plaintext highlighter-rouge">healthz.json</code> )</p>

<p><strong>meta</strong></p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">config.json</code>: 放置 Sonobuoy 的設定檔。</li>
  <li><code class="language-plaintext highlighter-rouge">query-time.json</code>: Sonobuoy 在處理各種 Resource 的反應時間，類似 Performenace Testing 。</li>
  <li><code class="language-plaintext highlighter-rouge">run.log</code>: Sonobuoy執行的 log ，注意這不是 Kubernetes Log。</li>
</ul>

<p><strong>plugins</strong><br />
放置 Plugins 的詳細資訊。</p>

<p><strong>podlogs</strong><br />
放置 Pod 的 Log ，注意這裡預設只會有 Sonobuoy 產生的 Pod 的 Log。</p>

<p><strong>resources</strong><br />
放置 Kubernetes Cluster 的 Resource 資訊。</p>

<p><code class="language-plaintext highlighter-rouge">Cluster</code>: 放所有不屬於任何 Namespaces 的 Resources，如 RoleBinding 、 Namespaces 等等。
<code class="language-plaintext highlighter-rouge">ns</code>: 放各個不同 Namespaces 的 Resources。</p>

<p>這邊是依照 Resource 種類去作分類，一個種類就是一個 JSON 檔，例如 <code class="language-plaintext highlighter-rouge">pohsien namespace</code> 裡面有100個 Pod ， Sonobuoy 就會在 <code class="language-plaintext highlighter-rouge">resources/ns/pohsien/pods.json</code> 放100個 Pod 資訊，並不會有100個 JSON 檔。</p>

<p><img data-src="/assets/images/e2e_k8s/sonobuoy_result.png" style="width:100%" data-proofer-ignore></p>

<h3 id="sonobuoy-vs-kubetest"><span class="mr-2"><code class="language-plaintext highlighter-rouge"><span class="mr-2">Sonobuoy</code> vs <code class="language-plaintext highlighter-rouge"><span class="mr-2">kubetest</code></span><a href="#sonobuoy-vs-kubetest" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3>
<p>Sonobuoy 提供了比 kubetest 更加簡單的方式執行 Conformance Test，其不需要 Build Kubernetes Binary ，也不需要比較麻煩的步驟執行測試。輸出結果部分，Sonobuoy 也提供很完善的 Output 機制，方便測試人員去查看測試結果。因為上述的優點，所以 Sonobuoy 成為了目前主流的 Kubernetes Conformance Testing Tool 。</p>

<p>但是由於 Sonobuoy 畢竟是第三方的工具，它會從 Kubernetes 官方目錄取得測項以及需要的資料並放置在 Sonobuoy Docker Image ，這提升了使用上方便性，但也導致其可能會沒辦法取得最新的測試項目。主要因為 Kubernetes 更新速度非常快，在每一次的更新之後， Sonobuoy 都會需要去更新 Image，而在等待 Sonobuoy 更新這段時間測項就會出現落差。不過筆者認為如果沒有要測試最新版本的 Cluster ，就比較不需要擔心這個問題，或著是可以設定排程一段時間更新 Sonobuoy ，然後再次做測試。</p>

<h2 id="summary"><span class="mr-2">Summary</span><a href="#summary" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2>
<p>在這系列文我們介紹了 Kubernets End to End Testing ，包括怎使用 kubetest 執行 E2E Test 以及 Conformance Test ，也簡單介紹了如何撰寫自己的測項，最後也介紹如何使用 CNCF 官方的 Comformance Testing Tool - Sonobuoy 。</p>

<p>E2E Testing 是在企業導入 Kubernetes 流程中是相當重要的一步，無論是使用什麼工具部署，建議都使用 E2E Testing 來驗證 Cluster 是否正常，這樣當發生任何問題時，比較可以排除掉 Cluster 本身的問題，減少問題定位的成本。</p>

<p>另外也可以定期的執行 E2E Testing / Conformance Testing 或是直接將測試整合進 CI/CD 流程裡，不過最好根據自己的環境狀況來評估，雖然 Conformance Testing 是無破壞性的測試，但是直接對於 Production 環境去做測試其實還是會有一些風險 (例如影響效能或是非預期內錯誤等等) ，因此還是需要特別注意，或著是也可以在測試前，先將重要服務轉移出去，待測試完成後再轉移回來，也是一個方法，實際執行方式可以根據自己的環境去做評估。</p>

<h2 id="references"><span class="mr-2">References</span><a href="#references" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2>
<ol>
  <li><a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/conformance-tests.md">Conformance Testing in Kubernetes</a></li>
  <li><a href="https://github.com/cncf/k8s-conformance/blob/master/docs/KubeConformance-1.9.md">Kubernetes Conformance Test Suite - v1.9</a></li>
  <li><a href="https://github.com/kubernetes/kubernetes/blob/master/test/conformance/testdata/conformance.txt">Conformance.txt</a></li>
  <li><a href="https://github.com/vmware-tanzu/sonobuoy">Sonobuoy</a></li>
  <li><a href="https://github.com/cncf/k8s-conformance#certified-kubernetes">CNCF - Certified Kubernetes</a></li>
</ol>

<blockquote class="prompt-info"><div>
  <p>文章內容的轉載、重製、發佈，請註明出處: <a href="https://pohsienshih.github.io">https://pohsienshih.github.io</a></p>
</div></blockquote>

</div>

<div class="post-tail-wrapper text-muted">

  <!-- categories -->
  
  <div class="post-meta mb-3">
    <i class="far fa-folder-open fa-fw mr-1"></i>
    
      <a href='/categories/kubernetes/'>Kubernetes</a>
  </div>
  

  <!-- tags -->
  
  <div class="post-tags">
    <i class="fa fa-tags fa-fw mr-1"></i>
      
      <a href="/tags/kubernetes/"
          class="post-tag no-text-decoration" >kubernetes</a>
      
      <a href="/tags/testing/"
          class="post-tag no-text-decoration" >testing</a>
      
  </div>
  

  <div class="post-tail-bottom
    d-flex justify-content-between align-items-center mt-3 pt-5 pb-2">
    <div class="license-wrapper">

      

        

        This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.

      
    </div>

    <!--
 Post sharing snippet
-->

<div class="share-wrapper">
  <span class="share-label text-muted mr-1">Share</span>
  <span class="share-icons">
    
    

    
      
        <a href="https://twitter.com/intent/tweet?text=End-to-End Testing for Kubernetes (Part II) - Conformance Testing - Po-Hsien Workspace&amp;url=http://0.0.0.0:4000/blog/e2e-testing-for-kubernetes-part-ii/" data-toggle="tooltip" data-placement="top"
          title="Twitter" target="_blank" rel="noopener" aria-label="Twitter">
          <i class="fa-fw fab fa-twitter"></i>
        </a>
    
      
        <a href="https://www.facebook.com/sharer/sharer.php?title=End-to-End Testing for Kubernetes (Part II) - Conformance Testing - Po-Hsien Workspace&amp;u=http://0.0.0.0:4000/blog/e2e-testing-for-kubernetes-part-ii/" data-toggle="tooltip" data-placement="top"
          title="Facebook" target="_blank" rel="noopener" aria-label="Facebook">
          <i class="fa-fw fab fa-facebook-square"></i>
        </a>
    
      
        <a href="https://t.me/share/url?url=http://0.0.0.0:4000/blog/e2e-testing-for-kubernetes-part-ii/&amp;text=End-to-End Testing for Kubernetes (Part II) - Conformance Testing - Po-Hsien Workspace" data-toggle="tooltip" data-placement="top"
          title="Telegram" target="_blank" rel="noopener" aria-label="Telegram">
          <i class="fa-fw fab fa-telegram"></i>
        </a>
    

    <i id="copy-link" class="fa-fw fas fa-link small"
        data-toggle="tooltip" data-placement="top"
        title="Copy link"
        data-title-succeed="Link copied successfully!">
    </i>

  </span>
</div>


  </div><!-- .post-tail-bottom -->

</div><!-- div.post-tail-wrapper -->


      
    
    

    </div>
  </div> <!-- #core-wrapper -->

  <!-- pannel -->
  <div id="panel-wrapper" class="col-xl-3 pl-2 text-muted">

    <div class="access">
      















      















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        



  <div id="access-tags">
    <div class="panel-heading">Trending Tags</div>
    <div class="d-flex flex-wrap mt-3 mb-1 mr-3">

    
      
      <a class="post-tag" href="/tags/kubernetes/">kubernetes</a>
    
      
      <a class="post-tag" href="/tags/personal/">Personal</a>
    
      
      <a class="post-tag" href="/tags/conference/">conference</a>
    
      
      <a class="post-tag" href="/tags/high-availability/">high availability</a>
    
      
      <a class="post-tag" href="/tags/pks/">pks</a>
    
      
      <a class="post-tag" href="/tags/testing/">testing</a>
    
      
      <a class="post-tag" href="/tags/activemq/">activemq</a>
    
      
      <a class="post-tag" href="/tags/elk/">ELK</a>
    
      
      <a class="post-tag" href="/tags/log/">log</a>
    
      
      <a class="post-tag" href="/tags/mariadb/">mariadb</a>
    

    </div>
  </div>


    </div>

    
      
      



<!-- BS-toc.js will be loaded at medium priority -->
<script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script>

<div id="toc-wrapper" class="pl-0 pr-4 mb-5">
  <div class="panel-heading pl-3 pt-2 mb-2">Contents</div>
  <nav id="toc" data-toggle="toc"></nav>
</div>


    
  </div>

</div>

<!-- tail -->

<div class="row">
  <div class="col-12 col-lg-11 col-xl-8">
    <div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4">
      
        
        <!--
 Recommend the other 3 posts according to the tags and categories of the current post,
 if the number is not enough, use the other latest posts to supplement.
-->

<!-- The total size of related posts  -->


<!-- An random integer that bigger than 0  -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy}  -->








  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  
    
  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  


  

  

  

  

  

  








<!-- Fill with the other newlest posts  -->






  <div id="related-posts" class="mt-5 mb-2 mb-sm-4">
    <h3 class="pt-2 mt-1 mb-4 ml-1"
      data-toc-skip>Further Reading</h3>
    <div class="card-deck mb-4">
    
      
      
      <div class="card">
        <a href="/blog/e2e-testing-for-kubernetes-part-i/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/timeago.js
-->

<em class="timeago small"
    data-ts="1572023779"
    
    >
  2019-10-25
</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>End-to-End Testing for Kubernetes (Part I) - kubetest</h3>
            <div class="text-muted small">
              <p>
                





                現今 Kubernetes Cluster 部署方式越來越多種，部署門檻也越來越低，但是在部署完之後要如何確認自己的 Cluster 真的是正常可用的？ 大多數的人(包含筆者以前)都是簡單部署一些 Deployment 或是 Service 看是否有 running 就認為 Cluster 是正常的，或是部署時沒有看到什麼錯誤訊息就覺得沒事，但是這樣是不太足夠的，因為有可能壞掉的是一些不常使...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/blog/enterprise-pks-k8s-node-disk-out-of-space/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/timeago.js
-->

<em class="timeago small"
    data-ts="1562102544"
    
    >
  2019-07-02
</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>針對Enterprise PKS環境的K8s Cluster Node硬碟空間不足測試及解法</h3>
            <div class="text-muted small">
              <p>
                





                
  此篇文章已不再更新，內容可能已過時


這篇主要是測試Enterprise PKS佈出來的Kubernetes Node 上面的硬碟滿了會造成什麼影響以及要如何解決。其實這個問題應該跟一般Kubernetes環境差不多，只是目前有一些case緣故還是需要在Enterprise PKS環境下測試一下。因此特別針對這部分做測試。


Kubernetes Node上的disk種類
在PCF...
              </p>
            </div>
          </div>
        </a>
      </div>
    
      
      
      <div class="card">
        <a href="/blog/enterprise-pks-introduction/">
          <div class="card-body">
            <!--
  Date format snippet
  See: ${JS_ROOT}/utils/timeago.js
-->

<em class="timeago small"
    data-ts="1561680417"
    
    >
  2019-06-28
</em>

            <h3 class="pt-0 mt-1 mb-3" data-toc-skip>Enterprise PKS介紹</h3>
            <div class="text-muted small">
              <p>
                





                
  此篇文章已不再更新，內容可能已過時


PKS全名是Pivotal Container Service，顧名思義是由Pivotal這間公司開發的。Pivotal是VMware的子公司，也許比較少人知道這間公司，不過相信大家應該都聽過tomcat或是redis，這兩個知名的專案就是由Pivotal開發的，由此可知Pivotal也是一家技術非常扎實強大的公司。

PKS介紹
PKS是用來管...
              </p>
            </div>
          </div>
        </a>
      </div>
    
    </div> <!-- .card-deck -->
  </div> <!-- #related-posts -->


      
        
        <!--
  Navigation buttons at the bottom of the post.
-->

<div class="post-navigation d-flex justify-content-between">
  
  <a href="/blog/e2e-testing-for-kubernetes-part-i/" class="btn btn-outline-primary"
    prompt="Older">
    <p>End-to-End Testing for Kubernetes (Part I) - kubetest</p>
  </a>
  

  
  <a href="/blog/2020-voicetube-hero/" class="btn btn-outline-primary"
    prompt="Newer">
    <p>2020 VoiceTube Hero 零元挑戰心得</p>
  </a>
  

</div>

      
        
        <!--  The comments switcher -->


      
    </div>
  </div>
</div> <!-- .row -->



        <!--
  The Footer
-->

<footer class="d-flex w-100 justify-content-center">
  <div class="d-flex justify-content-between align-items-center text-muted">
    <div class="footer-left">
      <p class="mb-0">
        © 2022
        <a href="https://github.com/username">Po-Hsien Shih</a>.
        
        <span data-toggle="tooltip" data-placement="top"
          title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span>
        
      </p>
    </div>

    <div class="footer-right">
      <p class="mb-0">
        

        

        Powered by 
          <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>
         with 
          <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a>
         theme.

      </p>
    </div>

  </div> <!-- div.d-flex -->
</footer>


      </div>

      <!--
  The Search results
-->
<div id="search-result-wrapper" class="d-flex justify-content-center unloaded">
  <div class="col-12 col-sm-11 post-content">
    <div id="search-hints">
      















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        



  <div id="access-tags">
    <div class="panel-heading">Trending Tags</div>
    <div class="d-flex flex-wrap mt-3 mb-1 mr-3">

    
      
      <a class="post-tag" href="/tags/kubernetes/">kubernetes</a>
    
      
      <a class="post-tag" href="/tags/personal/">Personal</a>
    
      
      <a class="post-tag" href="/tags/conference/">conference</a>
    
      
      <a class="post-tag" href="/tags/high-availability/">high availability</a>
    
      
      <a class="post-tag" href="/tags/pks/">pks</a>
    
      
      <a class="post-tag" href="/tags/testing/">testing</a>
    
      
      <a class="post-tag" href="/tags/activemq/">activemq</a>
    
      
      <a class="post-tag" href="/tags/elk/">ELK</a>
    
      
      <a class="post-tag" href="/tags/log/">log</a>
    
      
      <a class="post-tag" href="/tags/mariadb/">mariadb</a>
    

    </div>
  </div>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>


    </div> <!-- #main-wrapper -->

    

    <div id="mask"></div>

    <a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button">
      <i class="fas fa-angle-up"></i>
    </a>

    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script>

<script>
SimpleJekyllSearch({
  searchInput: document.getElementById('search-input'),
  resultsContainer: document.getElementById('search-results'),
  json: '/assets/js/data/search.json',
  searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0">  <a href="{url}">{title}</a>  <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">    {categories}    {tags}  </div>  <p>{snippet}</p></div>',
  noResultsText: '<p class="mt-5">Oops! No result founds.</p>',
  templateMiddleware: function(prop, value, template) {
    if (prop === 'categories') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
      }
    }

    if (prop === 'tags') {
      if (value === '') {
        return `${value}`;
      } else {
        return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
      }
    }
  }
});
</script>


    <!--
  JS selector for site.
-->

<!-- layout specified -->


  



  <!-- image lazy-loading & popup & clipboard -->
  

  







  
    

    

  



  
    

    

  



  
    

    

  




  <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script>







  

  

  







  
    

    

  



  
    

    

  



  
    

    

  



  
    

    

  




  <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script>








<script defer src="/assets/js/dist/post.min.js"></script>



<!-- commons -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script>




  </body>

</html>

